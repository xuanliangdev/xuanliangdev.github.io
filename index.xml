<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>xuanliang</title>
    <link>https://xuanliangdev.github.io/</link>
    <description>Recent content on xuanliang</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>en</language>
    <lastBuildDate>Sat, 03 Aug 2019 00:00:00 +0000</lastBuildDate>
    
        <atom:link href="https://xuanliangdev.github.io/index.xml" rel="self" type="application/rss+xml" />
    
    
    <item>
      <title>About</title>
      <link>https://xuanliangdev.github.io/about/</link>
      <pubDate>Sat, 03 Aug 2019 00:00:00 +0000</pubDate>
      
      <guid>https://xuanliangdev.github.io/about/</guid>
      
        <description>

&lt;h2 id=&#34;å¦‚æœä½ æœ‰ç†æƒ³åœ¨è¿œæ–¹-å°±ä¸è¦è¢«è·¯è¾¹çš„é£æ™¯å½±å“äº†å‰è¿›çš„é€Ÿåº¦-å› ä¸ºäººçš„æ—¶é—´æ˜¯æœ‰é™çš„&#34;&gt;â€”â€”å¦‚æœä½ æœ‰ç†æƒ³åœ¨è¿œæ–¹ï¼Œå°±ä¸è¦è¢«è·¯è¾¹çš„é£æ™¯å½±å“äº†å‰è¿›çš„é€Ÿåº¦ï¼Œå› ä¸ºäººçš„æ—¶é—´æ˜¯æœ‰é™çš„ã€‚&lt;/h2&gt;

&lt;p&gt;æ¥å°ç±³å·®ä¸€ä¸ªæœˆå°±æ»¡ä¸€å¹´äº†ï¼Œä¸æ¥ä¹‹å‰çš„é›„å¿ƒå£®å¿—ç›¸æ¯”ï¼Œè¿›æ­¥ä¹‹ç¼“æ…¢è¶…å‡ºäº†é¢„æœŸï¼Œä¸»è¦è¿˜æ˜¯æ²¡æœ‰å®šä¸‹åˆ‡å®çš„ç›®æ ‡å¹¶åšæŒæ‰§è¡Œï¼Œæ²¡æœ‰åœ¨ç¹å¿™çš„æ‚æ´»ä¸­æˆ–è€…æŠ½å‡ºç©ºé—²æ—¶é—´æ€»ç»“æå‡ï¼Œç”šè‡³ä»ä»Šå¹´4æœˆä¸­æ—¬å¼€å§‹èƒ¡æ€ä¹±æƒ³åˆ°äº†ç°åœ¨ï¼Œè¿·å¤±äº†è‡ªå·±ï¼Œæµªè´¹äº†3ä¸ªåŠæœˆï¼Œä»Šå¤©å¼€å§‹é‡æ–°åˆ¶å®šåŠå¹´è®¡åˆ’å¹¶æ‰§è¡Œï¼Œå°½ä¸€åˆ‡åŠªåŠ›æ’é™¤æ‚å¿µğŸ’ªã€‚&lt;/p&gt;

&lt;p&gt;äººæ²¡æœ‰ç›®æ ‡å°±ä¼šèƒ¡æ€ä¹±æƒ³ï¼Œæœ‰äº†ç›®æ ‡å°±è¦åˆ‡å®æ‰§è¡Œï¼Œä¸ç„¶å°±ä¼šåœæ»ä¸å‰ç”šè‡³å€’é€€ã€‚&lt;/p&gt;

&lt;p&gt;ä»Šå¤©æ˜¯2019å¹´8æœˆ3æ—¥ï¼Œä½“æ£€å‘ç°ç”²çŠ¶è…ºç»“èŠ‚ï¼Œè¿˜å¥½æ˜¯è‰¯æ€§çš„ã€‚ã€‚ã€‚&lt;/p&gt;
</description>
      
    </item>
    
    <item>
      <title>preferenceä½“ç³»å­¦ä¹ æ€»ç»“</title>
      <link>https://xuanliangdev.github.io/post/preference%E4%BD%93%E7%B3%BB%E5%AD%A6%E4%B9%A0/</link>
      <pubDate>Sat, 03 Aug 2019 00:00:00 +0000</pubDate>
      
      <guid>https://xuanliangdev.github.io/post/preference%E4%BD%93%E7%B3%BB%E5%AD%A6%E4%B9%A0/</guid>
      
        <description>

&lt;h1 id=&#34;1-preferenceä½“ç³»å­¦ä¹ æ€»ç»“&#34;&gt;1.preferenceä½“ç³»å­¦ä¹ æ€»ç»“&lt;/h1&gt;

&lt;p&gt;ç±»å›¾&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;https://ws2.sinaimg.cn/large/006tNbRwgy1fx3akmgz13j31cg133k17.jpg&#34; alt=&#34;preferenceclass&#34; /&gt;&lt;/p&gt;

&lt;p&gt;ç¬¬ä¸€éƒ¨åˆ†ä¸»è¦å­¦ä¹ äº†preferenceä½“ç³»çš„ç›¸å…³çŸ¥è¯†ï¼ˆç±»å›¾ä¸­è“è‰²å’Œç»¿è‰²éƒ¨åˆ†ï¼‰&lt;/p&gt;

&lt;h2 id=&#34;1-1-æ•°æ®ç»“æ„æè¿°&#34;&gt;1.1 æ•°æ®ç»“æ„æè¿°&lt;/h2&gt;

&lt;p&gt;&lt;strong&gt;1.1.1&lt;/strong&gt; &lt;strong&gt;preference&lt;/strong&gt;ï¼š&lt;/p&gt;

&lt;p&gt;è®¾ç½®çš„åŸºçŸ³ï¼Œç®€å•æ¥è®²å¯ä»¥è®¤ä¸ºæ˜¯è®¾ç½®åˆ—è¡¨ä¸­çš„æ¯ä¸€ä¸ªé¡¹ç›®ã€‚&lt;/p&gt;

&lt;p&gt;å…¶ä¸­æœ‰ä¸ªé‡è¦çš„æ–¹æ³•getViewï¼Œè¿™ä¸ªæ–¹æ³•è¿”å›çš„Viewå°†ä¼šè¢«æ·»åŠ åˆ°PreferenceFragmentæˆ–PreferenceActivityé‡Œ&lt;/p&gt;

&lt;p&gt;ä½œç”¨ï¼šæä¾›ä¸€ä¸ªviewç»™å³å°†è¢«å±•ç¤ºçš„activityå¹¶ä¸”å…³è”ä¸€ä¸ªsharepreferencesæ¥ä¿å­˜æˆ–å–å‡ºpreferenceæ•°æ®ï¼Œå…¶ä»–å¸¸ç”¨çš„preferenceå­ç±»éƒ½ç»§æ‰¿äºè¯¥ç±»ä»è€Œè¿›è¡Œviewæ ·å¼çš„æ”¹å˜ã€‚&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;1.1.2ï¼ˆv7åŒ…çš„Preferenceï¼‰&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;å»é™¤äº†getViewæ–¹æ³•ï¼Œå¢åŠ äº†ç»§æ‰¿äºRecycleView.ViewHolderçš„PreferenceViewHolderç±»&lt;/p&gt;

&lt;hr /&gt;

&lt;p&gt;&lt;strong&gt;1.1.3&lt;/strong&gt; &lt;strong&gt;PreferenceGroup&lt;/strong&gt;:&lt;/p&gt;

&lt;p&gt;ç»§æ‰¿äºPreferenceGroupï¼Œå†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ªå…ƒç´ ä¸ºPreferenceçš„Listï¼Œå’ŒPreferenceçš„å…³ç³»ç±»ä¼¼äºViewå’ŒViewGroupä¸€æ ·ï¼Œé‡‡ç”¨äº†ç»„åˆæ¨¡å¼è¿›è¡Œç»„ç»‡ã€‚&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;1.1.4ï¼ˆv7åŒ…çš„PreferenceGroupï¼‰&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;ä¸æ—§å®ç°ç±»ä¼¼ï¼Œæ”¹åŠ¨ä¸å¤§&lt;/p&gt;

&lt;hr /&gt;

&lt;p&gt;&lt;strong&gt;1.1.5&lt;/strong&gt; &lt;strong&gt;PreferenceScreen&lt;/strong&gt;ï¼š&lt;/p&gt;

&lt;p&gt;ç»§æ‰¿äºPreferenceGroupï¼Œæ˜¯ä¸€ä¸ªç•Œé¢çš„rootèŠ‚ç‚¹ã€‚å½“ä¸€ä¸ªPreferenceScreenåµŒå¥—åœ¨å¦ä¸€ä¸ªPreferenceScreenå†…éƒ¨æ—¶ä¼šä»¥Dialogçš„å½¢å¼å¼€å¯ä¸€ä¸ªæ–°çš„ç•Œé¢è¿›è¡Œæ˜¾ç¤ºã€‚&lt;/p&gt;

&lt;p&gt;å†…éƒ¨æŒæœ‰ä¸€ä¸ªlistViewï¼Œä¸€ä¸ªlistAdapterï¼ˆPreferenceGroupAdapterï¼‰ï¼ŒæŒæœ‰ä¸€ä¸ªlayoutæ–‡ä»¶&amp;rdquo;com.android.internal.R.layout.preference_list_fragment&amp;rdquo;çš„idï¼Œè¿˜æœ‰ä¸€ä¸ªDialogï¼Œç”¨äºå±•ç¤ºåµŒå¥—çš„preferenceScreen&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;1.1.6 ï¼ˆv7åŒ…çš„PreferenceScreenï¼‰&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;ä¸æ—§å®ç°å¯¹æ¯”è§£è€¦äº†å…³è”çš„Viewä½“ç³»çš„ä¸œè¥¿ï¼Œæ›´åŠ ç®€æ´ã€‚&lt;/p&gt;

&lt;hr /&gt;

&lt;p&gt;&lt;strong&gt;1.1.7 PreferenceManager&lt;/strong&gt; ï¼š&lt;/p&gt;

&lt;p&gt;ç®¡ç†ç±»ï¼Œç”¨XmlPullParseréå†è§£æxmlæ–‡ä»¶æ¥åˆ›å»ºpreferenceã€‚&lt;/p&gt;

&lt;p&gt;1.é‡è¦çš„å±æ€§&lt;/p&gt;

&lt;p&gt;activityï¼Œfragmentï¼Œsharepreferenceï¼ŒpreferenceDataStoreï¼ŒpreferenceScreenï¼›&lt;/p&gt;

&lt;p&gt;å…³è”äº†ä¸€ä¸ªæ ¹å¸ƒå±€â€œPreferenceScreenâ€ï¼Œå’ŒSharedPreferenceè¿›è¡Œäº¤äº’ã€‚&lt;/p&gt;

&lt;p&gt;2.é‡è¦çš„æ–¹æ³•&lt;/p&gt;

&lt;p&gt;inflateFromResourceï¼šé€šè¿‡PreferenceInflaterï¼ˆç»§æ‰¿äºGenericInflaterï¼‰é€’å½’åœ°æ‰«æxmlæ–‡ä»¶å–å‡ºæ‰€æœ‰èŠ‚ç‚¹ä¿¡æ¯æ¥æ„å»ºå‡ºPreferenceScreenå¯¹è±¡ã€‚&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;1.1.8 ï¼ˆv14åŒ…çš„PreferenceManagerï¼‰&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;å¢åŠ äº†ä¸€äº›æ¥å£OnDisplayPreferenceDialogListenerã€OnNavigateToScreenListener&lt;/p&gt;

&lt;hr /&gt;

&lt;p&gt;&lt;strong&gt;1.1.9 PreferenceFragmentï¼š&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;ç”¨äºæ˜¾ç¤ºpreferenceå¯¹è±¡åˆ—è¡¨&lt;/p&gt;

&lt;p&gt;æŒæœ‰ä¸€ä¸ªlistViewï¼Œæœ€ç»ˆä¼šå…³è”åˆ°PreferenceScreençš„listViewï¼Œå®ç°äº†onPreferenceTreeClickæ¥å£ï¼Œè¿™ä¸ªæ¥å£ä¼šåœ¨ListViewçš„é¡¹è¢«ç‚¹å‡»æ—¶å›è°ƒã€‚&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;1.1.10ï¼ˆv14åŒ…çš„PreferenceFragmentï¼‰&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;ä¸æ—§å®ç°ç›¸æ¯”æ”¹åŠ¨è¾ƒå¤§ã€‚ä¸»è¦æ˜¯é‡‡ç”¨äº†RecyclerViewå¹¶ä¸”å®ç°äº†ä¸€äº›Dialogçš„æ¥å£ã€‚&lt;/p&gt;

&lt;p&gt;å…³è”äº†recycleViewå’ŒpreferenceManager&lt;/p&gt;

&lt;hr /&gt;

&lt;p&gt;&lt;strong&gt;1.1.11 PreferenceActivity&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;ç»§æ‰¿äºListActivityï¼Œé‡è¦çš„å†…éƒ¨ç±»&lt;/p&gt;

&lt;p&gt;Headerï¼š&lt;/p&gt;

&lt;p&gt;HeaderåŒ…å«çš„å±æ€§ï¼š&lt;/p&gt;

&lt;p&gt;1.titleï¼› 2.summaryï¼›3.iconï¼›4.fragmentï¼›5.intentï¼›6.bundleï¼›&lt;/p&gt;

&lt;p&gt;HeaderAdapter&lt;/p&gt;

&lt;p&gt;HeaderAdapteråŒ…å«çš„å±æ€§ï¼š1.iconï¼›2.titleï¼›3.summary&lt;/p&gt;

&lt;p&gt;ä»è¿™ä¸ªadapterå’Œlayoutå¸ƒå±€(preference_header_item.xml)å¯ä»¥çœ‹å‡ºä¸€ä¸ªheaderåªæœ‰è¿™ä¸‰é¡¹ã€‚&lt;/p&gt;

&lt;hr /&gt;

&lt;h2 id=&#34;1-2-preferencefragmentåŠ è½½xmlæºç åˆ†æ-æ—§&#34;&gt;1.2 PreferenceFragmentåŠ è½½xmlæºç åˆ†æï¼ˆæ—§ï¼‰&lt;/h2&gt;

&lt;p&gt;&lt;img src=&#34;https://ws3.sinaimg.cn/large/006tNbRwgy1fwwaqbe99dj30ul14l76u.jpg&#34; alt=&#34;PreferenceFragmentBuild&#34; /&gt;&lt;/p&gt;

&lt;p&gt;é‡è¦æµç¨‹è¯´æ˜ï¼š&lt;/p&gt;

&lt;p&gt;ç¬¬8æ­¥ï¼šPreferenceInflateræ˜¯ä¸€ä¸ªxmlè§£æå™¨ï¼Œé€šè¿‡è§£æxmlå–å‡ºèŠ‚ç‚¹ï¼Œç„¶ååå°„ç”ŸæˆPreferenceScreenå¯¹è±¡&lt;/p&gt;

&lt;h2 id=&#34;1-3-preferencefragmentç‚¹å‡»äº‹ä»¶è§¦å‘æµç¨‹-æ—§&#34;&gt;1.3  PreferenceFragmentç‚¹å‡»äº‹ä»¶è§¦å‘æµç¨‹ï¼ˆæ—§ï¼‰&lt;/h2&gt;

&lt;pre&gt;&lt;code&gt;AbsListViewé‡Œçš„onKeyUp
    AdapterViewé‡Œçš„performItemClick
        OnItemClickListenerçš„onItemClick
            Preferenceçš„performClick
                PreferenceManager.OnPreferenceTreeClickListenerçš„onPreferenceTreeClick
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;1-4-preferenceactivityåŠ è½½xmlæºç åˆ†æ&#34;&gt;1.4 PreferenceActivityåŠ è½½xmlæºç åˆ†æ&lt;/h2&gt;

&lt;p&gt;&lt;img src=&#34;https://ws1.sinaimg.cn/large/006tNbRwgy1fwgb5lgqgfj30ol0ktab8.jpg&#34; alt=&#34;preferenceActivityonCreate&#34; /&gt;&lt;/p&gt;

&lt;p&gt;é‡è¦æµç¨‹è¯´æ˜ï¼š&lt;/p&gt;

&lt;p&gt;ç¬¬4æ­¥ï¼šç”ŸæˆHeaderçš„æ–¹å¼ä¹Ÿæ˜¯é€šè¿‡xmlè§£æå™¨è§£æxmlçš„headerèŠ‚ç‚¹ç„¶ååå°„ç”ŸæˆHeaderå¯¹è±¡ã€‚&lt;/p&gt;

&lt;hr /&gt;

&lt;p&gt;æ— è®ºæ˜¯æ–°çš„loadHeadersFromResourceè¿˜æ˜¯æ—§çš„addPreferencesFromResourceï¼Œåº•å±‚è§£æxmléƒ½ç”¨çš„XmlPullParserç±»ã€‚&lt;/p&gt;

&lt;h2 id=&#34;1-5-preferenceactivityç‚¹å‡»äº‹ä»¶è§¦å‘æµç¨‹&#34;&gt;1.5. PreferenceActivityç‚¹å‡»äº‹ä»¶è§¦å‘æµç¨‹&lt;/h2&gt;

&lt;pre&gt;&lt;code&gt;AbsListViewé‡Œçš„onKeyUp    
    AdapterViewé‡Œçš„performItemClick
        OnItemClickListenerçš„onItemClick
            ListActivityé‡Œçš„onListItemClick
                PreferenceAcitvityé‡Œçš„onHeaderClick
                    ç„¶åæ ¹æ®fragmentæ˜¯å¦ä¸ºç©ºæ¥æ‰§è¡ŒswitchToHeaderæˆ–è€…startActivity
&lt;/code&gt;&lt;/pre&gt;

&lt;hr /&gt;

&lt;h1 id=&#34;2-aospä¸­settingæ¨¡å—å­¦ä¹ æ€»ç»“&#34;&gt;2.aospä¸­Settingæ¨¡å—å­¦ä¹ æ€»ç»“&lt;/h1&gt;

&lt;p&gt;ç±»å›¾&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;https://ws2.sinaimg.cn/large/006tNbRwgy1fx3akmgz13j31cg133k17.jpg&#34; alt=&#34;preferenceclass&#34; /&gt;&lt;/p&gt;

&lt;p&gt;ä¸»è¦åˆ†æåªåœ¨ç³»ç»ŸSettingsä¸­ä½¿ç”¨çš„éƒ¨åˆ†ï¼ˆé™¤å»ä¸Šé¢åˆ†æè¿‡çš„è“è‰²å’Œç»¿è‰²éƒ¨åˆ†ï¼‰&lt;/p&gt;

&lt;h4 id=&#34;2-1-settingsä¸»é¡µé¢çš„æ˜¾ç¤ºåˆ†æ&#34;&gt;2.1 Settingsä¸»é¡µé¢çš„æ˜¾ç¤ºåˆ†æï¼š&lt;/h4&gt;

&lt;p&gt;&lt;img src=&#34;https://ws2.sinaimg.cn/large/006tNbRwgy1fwv0gkkantj309c0ibmz4.jpg&#34; alt=&#34;pscreen&#34; /&gt;&lt;/p&gt;

&lt;p&gt;aospä¸­Pç‰ˆæœ¬è®¾ç½®ç•Œé¢å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œé™¤å»æ²¡æ˜¾ç¤ºçš„ï¼Œä¸»ç•Œé¢ä¸­ä¸€å…±å±•ç¤ºäº†12ä¸ªåˆ—è¡¨é¡¹ï¼Œå…ˆåˆ†æåˆ—è¡¨é¡¹ï¼Œåé¢å†åˆ†ææœç´¢å’Œsuggestioné¡¹ã€‚&lt;/p&gt;

&lt;p&gt;ä¸»Activityä¸ºSettingsï¼Œç»§æ‰¿äºSettingsActivityï¼Œå†…éƒ¨åŒ…å«ä¸€ä¸ªDashboardSummaryçš„Fragmentï¼Œä»ç±»å›¾ä¸Šçœ‹å‡ºDashboardSummaryå¹¶æ²¡æœ‰ç”¨åˆ°preferenceçš„é‚£ä¸€å¥—ä¸œè¥¿ã€‚å¸ƒå±€ä¹Ÿç›¸å¯¹ç®€å•ï¼Œåªæœ‰ä¸€ä¸ªFocusRecyclerViewï¼Œé¡µé¢çš„å¸ƒå±€ç”±DashboardAdapterè´Ÿè´£ï¼ŒDashboardAdapterç”¨åˆ°çš„æ‰€æœ‰æ•°æ®ç”±DashboardDataè¿›è¡Œæè¿°ã€‚è¿™é‡Œåªåˆ†æDashboardDataä¸­çš„DashboardCategoryï¼Œä¹Ÿå°±æ˜¯12ä¸ªåˆ—è¡¨é¡¹æ‰€å±çš„DashboardCategoryï¼Œå¯¹äºè®¾ç½®ä¸»ç•Œé¢æ¥è¯´åªæœ‰ä¸€ä¸ªDashboardCategoryï¼Œå¦‚ä¸‹ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;&amp;lt;meta-data android:name=&amp;quot;com.android.settings.category&amp;quot;
    android:value=&amp;quot;com.android.settings.category.ia.homepage&amp;quot;/&amp;gt;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ä»android manifestä¸­ä¹Ÿå¯ä»¥çœ‹åˆ°12ä¸ªè¿™æ ·çš„æ•°æ®ï¼Œä»£è¡¨ä¸»ç•Œé¢çš„12ä¸ªåˆ—è¡¨é¡¹ã€‚&lt;/p&gt;

&lt;p&gt;ä»ç±»å›¾ä¸­å¯ä»¥çœ‹å‡ºä¸€ä¸ªåˆ—è¡¨é¡¹ç”±&lt;strong&gt;Tile&lt;/strong&gt;è¿™æ ·ä¸€ä¸ªæ•°æ®ç»“æ„è¿›è¡Œæè¿°ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;public class Tile implements Parcelable {
    public CharSequence title;
    public CharSequence summary;
    public Icon icon;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;strong&gt;DashboardCategory&lt;/strong&gt;è¡¨ç¤ºä¸€ä¸ªç±»åˆ«ï¼ŒæŒæœ‰ä¸€ä¸ªå…ƒç´ ä¸ºTileçš„Listè¡¨ï¼›&lt;/p&gt;

&lt;p&gt;å¯ä»¥å‘ç°Dashboardå’ŒPreferenceæœ‰å¾ˆå¤šç›¸ä¼¼çš„åœ°æ–¹&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;/**
 * Base fragment for dashboard style UI containing a list of static and dynamic setting items.
 */
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ä»æ³¨é‡Šå¯ä»¥çœ‹å‡ºDashboardFragmentæ˜¯ä¸ºäº†åŠ¨æ€åŠ è½½è€Œè®¾è®¡çš„ï¼Œç›¸å¯¹äºPreferenceæ˜¯é™æ€åœ°ä»xmlæ–‡ä»¶ä¸­è§£æè¯»å–çš„ã€‚&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;CategoryManager&lt;/strong&gt;ä¸»è¦æ˜¯å¯¹DashboardCategoryè¿›è¡Œç®¡ç†ï¼Œå†…éƒ¨ä¼šå€ŸåŠ©äº&lt;strong&gt;TileUtils&lt;/strong&gt;æ¥ç”ŸæˆDashboardCategoryå¯¹è±¡ï¼Œåœ¨ç”ŸæˆDashboardCategoryå¯¹è±¡æ—¶ä¼šå€ŸåŠ©PackageManageræ¥æŸ¥è¯¢æ‰‹æœºä¸­çš„å®‰è£…åŒ…ä¿¡æ¯æ¥è¿›è¡Œåˆ†æï¼Œæ¥åŠ¨æ€å†³å®šæ˜¯å¦å±•ç¤ºä¸€äº›é¡¹ã€‚&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;DashboardFeatureProviderImpl&lt;/strong&gt;å®ç°äº†&lt;strong&gt;DashboardFeatureProvider&lt;/strong&gt;æ¥å£ï¼ŒæŒæœ‰CategoryManagerå¯¹è±¡ï¼Œé€šè¿‡CategoryManagerå¯¹è±¡è¿›è¡ŒCategoryçš„è·å–&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;SuggestionFeatureProviderImpl&lt;/strong&gt;å®ç°äº†&lt;strong&gt;SuggestionFeatureProvider&lt;/strong&gt;æ¥å£ï¼Œåº”è¯¥æ˜¯ç”¨äºè·å–æ¨èä¿¡æ¯ï¼Œåé¢å†åˆ†æã€‚&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;FeatureFactoryImpl&lt;/strong&gt;å®ç°äº†&lt;strong&gt;FeatureFactory&lt;/strong&gt;æ¥å£ï¼Œé€šè¿‡åå°„ç”Ÿæˆï¼Œç”¨äºç”ŸæˆDashboardFeatureProviderImplå’ŒSuggestionFeatureProviderImplç­‰ä¸€äº›FeatureProviderå¯¹è±¡ã€‚&lt;/p&gt;

&lt;p&gt;æ•´ä¸ªè®¾ç½®ä¸»ç•Œé¢åŠ è½½æµç¨‹å¤§è‡´å¦‚å›¾æ‰€ç¤º&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;https://ws4.sinaimg.cn/large/006tNbRwgy1fww0pjn6xtj31kw1oewmo.jpg&#34; alt=&#34;dashboardsummary&#34; /&gt;&lt;/p&gt;

&lt;p&gt;å›¾ä¸­ç»¿è‰²ä¸ºä¸»çº¿ç¨‹ï¼Œå…¶ä»–çº¿ç¨‹ä¸ºåå°çº¿ç¨‹ã€‚&lt;/p&gt;

&lt;p&gt;å¯¹äºæµç¨‹åšä¸ªç®€å•çš„åˆ†æã€‚&lt;/p&gt;

&lt;h5 id=&#34;1-settingsactivityçš„oncreateæµç¨‹&#34;&gt;1. SettingsActivityçš„onCreateæµç¨‹&lt;/h5&gt;

&lt;p&gt;åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ä¼šè¿›è¡ŒFeatureFactoryã€DashboardFeatureProviderã€CategoryManagerçš„åˆå§‹åŒ–ï¼Œå¹¶ä¸”å¦‚æœåˆ¤æ–­æ˜¯ä¸»ç•Œé¢ï¼Œåˆ™å¯åŠ¨DashboardSummaryè¿™ä¸ªFragmentã€‚&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;p&gt;1.1 DashboardSummaryåœ¨onAttachä¸­ä¼šåˆ›å»ºSuggestionFeatureProviderï¼Œä½¿ä¹‹æ¥è¿›è¡Œæ¨èåŠŸèƒ½çš„å®ç°ã€‚&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;1.2 DashboardSummaryåœ¨onCreateä¸­ä¼šæˆåˆ›å»ºDashboardFeatureProviderï¼Œä»¥åŠæ–°å»ºä¸€ä¸ªSummaryLoaderï¼Œç”¨&amp;rdquo;om.android.settings.category.ia.homepage&amp;rdquo;æ¥ä½œä¸ºCategoryKeyï¼ŒSummaryLoaderæ„é€ æ—¶ä¼šå¯åŠ¨ä¸€ä¸ªHandlerThreadæ¥åœ¨åå°è¿è¡Œï¼Œä»¥ä¾¿éšæ—¶æ¥å—ä¸»çº¿ç¨‹å‘è¿‡æ¥çš„æ¶ˆæ¯ä»è€Œè§¦å‘SummaryProviderçš„setListeningæ–¹æ³•è¿›è¡ŒSummaryçš„æ›´æ–°ï¼Œæ¯”å¦‚æ›´æ–°å­˜å‚¨ç©ºé—´æˆ–è€…ç”µé‡çš„ç™¾åˆ†æ¯”ï¼Œæˆ–è€…æ ¹æ®ä¸åŒçš„æ‰‹æœºç‰¹æ€§æ˜¾ç¤ºä¸åŒçš„Summaryï¼Œæ¯”å¦‚åœ¨å®‰å…¨è®¾ç½®Fragmentä¸­å¯¹äºæ”¯æŒæŒ‡çº¹çš„æ‰‹æœºæ˜¾ç¤º&amp;rdquo;å±å¹•é”å®šã€æŒ‡çº¹&amp;rdquo;ï¼Œä¸æ”¯æŒæŒ‡çº¹çš„æ‰‹æœºä»…æ˜¾ç¤º&amp;rdquo;å±å¹•é”å®š&amp;rdquo;ã€‚&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;1.3  DashboardSummaryåœ¨onCreateViewä¸­ä¼šè¿›è¡Œviewç›¸å…³çš„å¤„ç†ï¼Œrootviewä¸ºR.layout.dashboardï¼Œè¿™ä¸ªviewä¸­åªæœ‰ä¸€ä¸ªç®€å•çš„RecycleViewï¼Œåˆ›å»ºDashboardAdapterï¼Œæ‰§è¡ŒrebuildUIæ–¹æ³•ï¼Œè¯¥æ–¹æ³•å¯åŠ¨ä¸€ä¸ªåå°çº¿ç¨‹è°ƒç”¨updateCategoryæ¥è¿›è¡ŒCategoryçš„æ›´æ–°ï¼Œæ›´æ–°å®Œæ¯•é€šè¿‡notifyDashboardDataChangedé€šçŸ¥ä¸»çº¿ç¨‹è¿›è¡Œviewçš„æ›´æ–°ï¼Œå¦‚æœéœ€è¦åŠ è½½æ¨èé¡¹ï¼Œæ¨èé¡¹æ²¡åŠ è½½ï¼Œåˆ™å‘ä¸»çº¿ç¨‹å‘é€ä¸€ä¸ªå»¶è¿Ÿæ›´æ–°viewçš„æ¶ˆæ¯ï¼Œé€šè¿‡Handlerçš„postDelayedæ–¹æ³•å®ç°ã€‚&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h5 id=&#34;2-settingsactivityçš„onresumeæµç¨‹&#34;&gt;2. SettingsActivityçš„onResumeæµç¨‹&lt;/h5&gt;

&lt;ul&gt;
&lt;li&gt;&lt;p&gt;2.1 è¿™ä¸ªæ–¹æ³•é¦–å…ˆä¼šåœ¨çˆ¶ç±»SettingsDrawerActivityçš„onResumeä¸­æ‰§è¡ŒCategoriesUpdateTaskï¼Œæ¥åœ¨åå°æ›´æ–°æ‰€æœ‰çš„Categoriesï¼Œè°ƒç”¨å®Œæ¯•åå›ä¸»çº¿ç¨‹è°ƒç”¨CategoryListeneræ¥å£çš„onCategoriesChangedæ–¹æ³•ï¼ŒDashboardFramentå’ŒDashboardSummaryå®ç°äº†è¯¥æ¥å£æ¥è¿›è¡ŒCategoryçš„åˆ·æ–°ã€‚&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;2.2 SettingsAcitvityåœ¨é‡å†™onResumeåå†æ¬¡å‘AsyncTaskä¸­postä¸€ä¸ªdoUpdateTilesListçš„æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•ä¼šæ’åœ¨CategoriesUpdateTaskä¹‹åæ‰§è¡Œï¼Œä¹Ÿæ˜¯ç”¨æ¥æ›´æ–°Categoriesçš„ã€‚&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;2.3 åœ¨DashboardSummaryçš„onResumeä¸­ï¼Œä¼šè°ƒç”¨SummaryLoaderçš„setListeningæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•ä¼šå‘HandlerThreadä¸­postæ¶ˆæ¯ï¼Œåˆ†æè¿™ä¸ªæ¶ˆæ¯ç±»å‹MSG_GET_CATEGORY_TILES_AND_SET_LISTENINGï¼Œå¯¹åº”æ—¶åºå›¾çš„47æ­¥ï¼Œåœ¨åå°çº¿ç¨‹è·å–åˆ°categoryåï¼Œéå†æ‰€æœ‰çš„tileï¼Œè°ƒç”¨makeProviderWæ–¹æ³•ï¼Œå› ä¸ºæ‰€æœ‰è¯¥categoryä¸‹çš„Fragmentéƒ½å®ç°äº†SummaryProviderä»¥åŠSummaryLoader.SummaryProviderFactoryï¼ŒSummaryProviderå®ç°äº†SummaryLoader.SummaryProvideræ¥å£ï¼Œå› æ­¤é€šè¿‡tileæ‰¾åˆ°ç›¸å…³çš„factoryåï¼Œå†é€šè¿‡åå°„ç”ŸæˆSummaryProviderå¯¹è±¡ï¼Œå¦‚æ—¶åºå›¾çš„52æ­¥ã€‚ç´§æ¥ç€åœ¨setListeningWä¸­éå†è°ƒç”¨æ‰€æœ‰çš„SummaryProviderçš„setListeningæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•è¿›ä¸€æ­¥è§¦å‘SummaryLoaderçš„setSummaryæ–¹æ³•æ¥è¿›è¡Œå„ä¸ªåˆ—è¡¨é¡¹summaryçš„åŠ¨æ€å˜åŒ–ï¼Œæ¯”å¦‚ç”µé‡çš„æ›´æ–°ç­‰ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;public void setSummary(SummaryProvider provider, final CharSequence summary) {
  final ComponentName component = mSummaryProviderMap.get(provider);
  ThreadUtils.postOnMainThread(() -&amp;gt; {
  
      final Tile tile = getTileFromCategory(
              mDashboardFeatureProvider.getTilesForCategory(mCategoryKey), component);
  
      if (tile == null) {
          if (DEBUG) {
              Log.d(TAG, &amp;quot;Can&#39;t find tile for &amp;quot; + component);
          }
          return;
      }
      if (DEBUG) {
          Log.d(TAG, &amp;quot;setSummary &amp;quot; + tile.title + &amp;quot; - &amp;quot; + summary);
      }
  
      updateSummaryIfNeeded(tile, summary);
  });
}
  
@VisibleForTesting
void updateSummaryIfNeeded(Tile tile, CharSequence summary) {
  if (TextUtils.equals(tile.summary, summary)) {
      if (DEBUG) {
          Log.d(TAG, &amp;quot;Summary doesn&#39;t change, skipping summary update for &amp;quot; + tile.title);
      }
      return;
  }
  mSummaryTextMap.put(mDashboardFeatureProvider.getDashboardKeyForTile(tile), summary);
  tile.summary = summary;
  if (mSummaryConsumer != null) {
      mSummaryConsumer.notifySummaryChanged(tile);
  } else {
      if (DEBUG) {
          Log.d(TAG, &amp;quot;SummaryConsumer is null, skipping summary update for &amp;quot;
                  + tile.title);
      }
  }
}
&lt;/code&gt;&lt;/pre&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;è€Œåœ¨SummaryLoaderçš„setSummaryæ–¹æ³•ä¸­å†é€šè¿‡SummaryConsumeræ¥å£çš„notifySummaryChangedæ–¹æ³•è¿›è¡Œç•Œé¢çš„æ›´æ–°ï¼Œå¯¹äºä¸»ç•Œé¢æ¥è¯´æ˜¯DashboardAdapterå®ç°äº†SummaryConsumeræ¥å£ï¼Œä¼šç›´æ¥è§¦å‘notifyItemChangedæ¥è¿›è¡Œviewçš„æ›´æ–°ï¼ˆå¯¹äºå…¶ä»–DashboardFragmentçš„å­ç±»æ¥è¯´åˆ™æ˜¯çˆ¶ç±»DashboardFragmentå®ç°äº†SummaryConsumeræ¥å£ï¼Œä¼šè§¦å‘Preferenceçš„setSummaryæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•ä¼šè°ƒç”¨notifyChangedæ–¹æ³•ï¼Œè¿›è€Œè§¦å‘OnPreferenceChangeInternalListenerçš„onPreferenceChangeæ–¹æ³•ï¼Œè€ŒPreferenceGroupAdapterå®ç°äº†è¯¥æ¥å£ï¼Œå› è€Œä¹Ÿä¼šè§¦å‘notifyItemChangedæ¥è¿›è¡Œviewçš„æ›´æ–°ï¼‰ã€‚&lt;/p&gt;

&lt;h3 id=&#34;2-2-securitysettingsé¡µé¢çš„æ˜¾ç¤ºæµç¨‹åˆ†æ&#34;&gt;2.2 SecuritySettingsé¡µé¢çš„æ˜¾ç¤ºæµç¨‹åˆ†æï¼š&lt;/h3&gt;

&lt;p&gt;Settingsä¸»ç•Œé¢çš„æ˜¾ç¤ºå®Œå…¨æ˜¯åŠ¨æ€çš„ï¼Œè€Œé™¤å»ä¸»ç•Œé¢å…¶ä»–çš„Fragmentçš„æ˜¾ç¤ºåˆ™æ˜¯åŠ¨æ€å’Œé™æ€ç›¸ç»“åˆï¼Œä»¥è¦åˆ†æçš„SecuritySettingsæ¥è¯´æ˜ã€‚SecuritySettingsçš„ç»§æ‰¿äºDashboardFragmentï¼Œè€ŒDashboardFragmentä¸»è¦å°±æ˜¯ç”¨æ¥åŠ è½½åŠ¨æ€å’Œé™æ€çš„itemã€‚DashboardFragmentæœ€ç»ˆç»§æ‰¿äºPreferenceFragmentï¼Œå› æ­¤å¯ä»¥è§£æxmlä¸­é…ç½®çš„preferenceæ¥è¿›è¡Œæ˜¾ç¤ºï¼Œè€Œä¸”æŒæœ‰DashboardFeatureProviderImplå¯¹è±¡ï¼Œå› æ­¤ä¹Ÿå¯ä»¥åŠ è½½DashboardCategoryä¸­çš„Tileè¿›è¡Œæ˜¾ç¤ºã€‚&lt;/p&gt;

&lt;p&gt;SecuritySettingsç•Œé¢æ˜¾ç¤ºæ˜¯è¿™ä¸ªæ ·å­çš„ï¼š&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;https://ws3.sinaimg.cn/large/006tNbRwgy1fww1moiavmj30990icwgc.jpg&#34; alt=&#34;securitysettings&#34; /&gt;&lt;/p&gt;

&lt;p&gt;layoutæ–‡ä»¶R.xml.security_dashboard_settingså¦‚ä¸‹æ‰€ç¤ºï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;&amp;lt;PreferenceScreen
    xmlns:android=&amp;quot;http://schemas.android.com/apk/res/android&amp;quot;
    xmlns:settings=&amp;quot;http://schemas.android.com/apk/res-auto&amp;quot;
    android:key=&amp;quot;security_dashboard_page&amp;quot;
    android:title=&amp;quot;@string/security_settings_title&amp;quot;
    settings:initialExpandedChildrenCount=&amp;quot;9&amp;quot;&amp;gt;

    &amp;lt;!-- security_settings_status.xml --&amp;gt;
    &amp;lt;PreferenceCategory
        android:order=&amp;quot;-10&amp;quot;
        android:key=&amp;quot;security_status&amp;quot;
        android:title=&amp;quot;@string/security_status_title&amp;quot; /&amp;gt;

    &amp;lt;PreferenceCategory
        android:order=&amp;quot;1&amp;quot;
        android:key=&amp;quot;dashboard_tile_placeholder&amp;quot; /&amp;gt;

    &amp;lt;!-- security section --&amp;gt;
    &amp;lt;PreferenceCategory
        android:order=&amp;quot;10&amp;quot;
        android:key=&amp;quot;security_category&amp;quot;
        android:title=&amp;quot;@string/lock_settings_title&amp;quot;&amp;gt;  &amp;lt;!-- è®¾å¤‡å®‰å…¨æ€§--&amp;gt;

        &amp;lt;com.android.settings.widget.GearPreference
            android:key=&amp;quot;unlock_set_or_change&amp;quot;
            android:title=&amp;quot;@string/unlock_set_unlock_launch_picker_title&amp;quot;
            android:summary=&amp;quot;@string/summary_placeholder&amp;quot;
            settings:keywords=&amp;quot;@string/keywords_lockscreen&amp;quot; /&amp;gt; &amp;lt;!-- å±å¹•é”å®š--&amp;gt;

        &amp;lt;Preference
            android:key=&amp;quot;lockscreen_preferences&amp;quot;
            android:title=&amp;quot;@string/lockscreen_settings_title&amp;quot; &amp;lt;!-- é”å±æ—¶çš„åå¥½è®¾ç½®--&amp;gt;
            android:summary=&amp;quot;@string/summary_placeholder&amp;quot;
            android:fragment=&amp;quot;com.android.settings.security.LockscreenDashboardFragment&amp;quot; /&amp;gt;

        &amp;lt;Preference
            android:key=&amp;quot;fingerprint_settings&amp;quot;
            android:title=&amp;quot;@string/security_settings_fingerprint_preference_title&amp;quot; &amp;lt;!-- æŒ‡çº¹--&amp;gt;
            android:summary=&amp;quot;@string/summary_placeholder&amp;quot;
            settings:keywords=&amp;quot;@string/keywords_fingerprint_settings&amp;quot;/&amp;gt;

    &amp;lt;/PreferenceCategory&amp;gt;
....

&amp;lt;/PreferenceScreen&amp;gt;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ä»£ç é‡Œä¼šè§£æè¿™ä¸ªxmlæ–‡ä»¶æ¥æ„é€ PreferenceScreenå¯¹è±¡ã€‚&lt;/p&gt;

&lt;p&gt;ä»å›¾é‡Œçœ‹åˆ°å¹¶æ²¡æœ‰æ˜¾ç¤ºé”å±æ—¶çš„åå¥½è®¾ç½®è¿™ä¸€ä¸ªPreferenceçš„æ¡ç›®ï¼Œä»æºç åˆ†ææ˜¯LockScreenPreferenceControllerè¿™ä¸ªç±»åŠ¨æ€çš„æ”¹å˜äº†è¿™ä¸€ä¸ªPreferenceçš„æ˜¾ç¤ºçŠ¶æ€ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;    @Override
    public int getAvailabilityStatus() {
        if (!mLockPatternUtils.isSecure(MY_USER_ID)) {
            return mLockPatternUtils.isLockScreenDisabled(MY_USER_ID)
                    ? DISABLED_FOR_USER : AVAILABLE;
        } else {
            return mLockPatternUtils.getKeyguardStoredPasswordQuality(MY_USER_ID)
                    == PASSWORD_QUALITY_UNSPECIFIED
                    ? DISABLED_FOR_USER : AVAILABLE;
        }
    }

    @Override
    public void updateState(Preference preference) {
        preference.setSummary(
                LockScreenNotificationPreferenceController.getSummaryResource(mContext));
    }

    @Override
    public void onResume() {
        mPreference.setVisible(isAvailable());
    }
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;è€Œè¿™ä¸‰ä¸ªitemå…¶å®æ˜¯é€šè¿‡åŠ¨æ€ä»DashboardTilesä¸­å–å‡ºæ¥çš„ã€‚ä¸‹é¢ç®€å•åˆ†æSecuritySettingsçš„æ˜¾ç¤ºè¿‡ç¨‹ï¼Œä¸»è¦æ˜¯DashboardFragmentçš„æµç¨‹åˆ†æã€‚&lt;/p&gt;

&lt;h4 id=&#34;2-2-1-dashboardfragmenetçš„onattachæµç¨‹&#34;&gt;2.2.1.DashboardFragmenetçš„onAttachæµç¨‹&lt;/h4&gt;

&lt;pre&gt;&lt;code&gt;@Override
public void onAttach(Context context) {
    super.onAttach(context);
    mDashboardFeatureProvider = FeatureFactory.getFactory(context).
            getDashboardFeatureProvider(context);
    final List&amp;lt;AbstractPreferenceController&amp;gt; controllers = new ArrayList&amp;lt;&amp;gt;();
    // Load preference controllers from code
    final List&amp;lt;AbstractPreferenceController&amp;gt; controllersFromCode =
            createPreferenceControllers(context);
    // Load preference controllers from xml definition
    final List&amp;lt;BasePreferenceController&amp;gt; controllersFromXml = PreferenceControllerListHelper
            .getPreferenceControllersFromXml(context, getPreferenceScreenResId());
    // Filter xml-based controllers in case a similar controller is created from code already.
    final List&amp;lt;BasePreferenceController&amp;gt; uniqueControllerFromXml =
            PreferenceControllerListHelper.filterControllers(
                    controllersFromXml, controllersFromCode);

    // Add unique controllers to list.
    if (controllersFromCode != null) {
        controllers.addAll(controllersFromCode);
    }
    controllers.addAll(uniqueControllerFromXml);
...

    mPlaceholderPreferenceController =
            new DashboardTilePlaceholderPreferenceController(context);
    controllers.add(mPlaceholderPreferenceController);
    for (AbstractPreferenceController controller : controllers) {
        addPreferenceController(controller);
    }
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æ–¹æ³•é‡Œä¸»è¦æ˜¯ä¸€äº›controllersçš„åˆ›å»ºï¼Œè¿™äº›controllerå¯ä»¥ä»ä»£ç åˆ›å»ºï¼Œä¹Ÿå¯ä»¥ä»xmlè§£æè·å–ï¼Œ&lt;/p&gt;

&lt;p&gt;åœ¨SecuritySettingsé‡Œé€šè¿‡ä»£ç åˆ›å»ºäº†ä¸€äº›controllerï¼Œå¦‚ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;    private static List&amp;lt;AbstractPreferenceController&amp;gt; buildPreferenceControllers(Context context,
            Lifecycle lifecycle, SecuritySettings host) {
        final List&amp;lt;AbstractPreferenceController&amp;gt; controllers = new ArrayList&amp;lt;&amp;gt;();
        controllers.add(new LocationPreferenceController(context, lifecycle));
        controllers.add(new ManageDeviceAdminPreferenceController(context));
        controllers.add(new EnterprisePrivacyPreferenceController(context));
        controllers.add(new ManageTrustAgentsPreferenceController(context));
        ...

        return controllers;
    }
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;åœ¨xmlä¸­æ˜¯é€šè¿‡å£°æ˜settings:controllerå±æ€§æ¥åˆ›å»ºçš„ï¼Œå¦‚&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;&amp;lt;SwitchPreference
    android:key=&amp;quot;visiblepattern_profile&amp;quot;
    android:summary=&amp;quot;@string/summary_placeholder&amp;quot;
    android:title=&amp;quot;@string/lockpattern_settings_enable_visible_pattern_title_profile&amp;quot;
    settings:controller=&amp;quot;com.android.settings.security.VisiblePatternProfilePreferenceController&amp;quot;/&amp;gt;
&lt;/code&gt;&lt;/pre&gt;

&lt;h4 id=&#34;2-2-1-dashboardfragmenetçš„oncreateæµç¨‹&#34;&gt;2.2.1.DashboardFragmenetçš„onCreateæµç¨‹&lt;/h4&gt;

&lt;p&gt;DashboardFragmenetæœ€ç»ˆç»§æ‰¿äºv14åŒ…é‡Œçš„PreferenceFragmentçš„onCreateæ–¹æ³•ï¼Œé‡Œé¢ä¼šè°ƒç”¨onCreatePreferencesæ–¹æ³•ï¼ŒDashboardFragmeneté‡å†™äº†onCreatePreferencesæ–¹æ³•ï¼Œè¿›è€Œè°ƒç”¨refreshAllPreferencesæ–¹æ³•ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;/**
 * Refresh all preference items, including both static prefs from xml, and dynamic items from
 * DashboardCategory.
 */
private void refreshAllPreferences(final String TAG) {
    // First remove old preferences.
    if (getPreferenceScreen() != null) {
        // Intentionally do not cache PreferenceScreen because it will be recreated later.
        getPreferenceScreen().removeAll();
    }

    // Add resource based tiles.
    displayResourceTiles();

    refreshDashboardTiles(TAG);
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ä»æ³¨é‡Šå¯ä»¥çœ‹å‡ºè¿™ä¸ªæ–¹æ³•æ˜¯è¿™ä¸ªFragmentæ˜¾ç¤ºæµç¨‹çš„æ ¸å¿ƒã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;/**
 * Displays resource based tiles.
 */
private void displayResourceTiles() {
    final int resId = getPreferenceScreenResId();
    if (resId &amp;lt;= 0) {
        return;
    }
    addPreferencesFromResource(resId);
    final PreferenceScreen screen = getPreferenceScreen();
    mPreferenceControllers.values().stream().flatMap(Collection::stream).forEach(
            controller -&amp;gt; controller.displayPreference(screen));
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;displayResourceTilesè¿™ä¸ªæ–¹æ³•é¦–å…ˆè·å–äº†PreferenceScreenï¼Œç„¶åé€šè¿‡å¾ªç¯è°ƒç”¨äº†æ¯ä¸ªcontrollerçš„displayPreferenceæ–¹æ³•&lt;/p&gt;

&lt;p&gt;ä»¥ä¸Šé¢è¯´çš„LockScreenPreferenceControllerä¸ºä¾‹ï¼ŒLockScreenPreferenceControllerç»§æ‰¿äºBasePreferenceControllerï¼Œå› æ­¤ä¼šè°ƒç”¨å¦‚ä¸‹æ–¹æ³•ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;/**
 * Displays preference in this controller.
 */
@Override
public void displayPreference(PreferenceScreen screen) {
    super.displayPreference(screen);
    if (getAvailabilityStatus() == DISABLED_DEPENDENT_SETTING) {
        // Disable preference if it depends on another setting.
        final Preference preference = screen.findPreference(getPreferenceKey());
        if (preference != null) {
            preference.setEnabled(false);
        }
    }
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ä»è€Œæ¥å†³å®šä¸€ä¸ªpreferenceæ˜¯å¦è¯¥æ˜¾ç¤ºã€‚&lt;/p&gt;

&lt;p&gt;æ‰§è¡Œå®ŒdisplayResourceTilesåæ¥ç€ä¼šæ‰§è¡ŒrefreshDashboardTilesæ–¹æ³•ï¼Œä»æ³¨é‡Šä¹Ÿå¯ä»¥çœ‹å‡ºè¿™ä¸ªæ–¹æ³•æ˜¯ç”¨æ¥å±•ç¤ºåŠ¨æ€DashboardCategoryçš„itemçš„&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;/**
 * Refresh preference items backed by DashboardCategory.
 */
@VisibleForTesting(otherwise = VisibleForTesting.PRIVATE)
void refreshDashboardTiles(final String TAG) {
    final PreferenceScreen screen = getPreferenceScreen();

    final DashboardCategory category =
            mDashboardFeatureProvider.getTilesForCategory(getCategoryKey());
    ...
    final List&amp;lt;Tile&amp;gt; tiles = category.getTiles();
    ...
    mSummaryLoader = new SummaryLoader(getActivity(), getCategoryKey());
    mSummaryLoader.setSummaryConsumer(this);
    ...
    // Install dashboard tiles.
    for (Tile tile : tiles) {
        final String key = mDashboardFeatureProvider.getDashboardKeyForTile(tile);
        ...
        if (mDashboardTilePrefKeys.contains(key)) {
            // Have the key already, will rebind.
            ....
        } else {
            // Don&#39;t have this key, add it.
            final Preference pref = new Preference(getPrefContext());
            mDashboardFeatureProvider.bindPreferenceToTile(getActivity(), getMetricsCategory(),
                    pref, tile, key, mPlaceholderPreferenceController.getOrder());
            screen.addPreference(pref);
            mDashboardTilePrefKeys.add(key);
        }
        remove.remove(key);
    }
    ...
    mSummaryLoader.setListening(true);
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;5-11è¡Œå–å‡ºç›¸å…³keyçš„tileå¯¹è±¡ã€‚å¯¹äºSecuritySettingsæ¥è¯´keyæ˜¯&amp;rdquo;com.android.settings.category.ia.security&amp;rdquo;ï¼Œä¸‰ä¸ªtileçš„titleä¸ºâ€œGoogle Play ä¿æŠ¤æœºåˆ¶ã€æŸ¥æ‰¾æˆ‘çš„è®¾å¤‡ã€å®‰å…¨æ›´æ–°â€ï¼Œå¦‚å‰é¢ä¸€èŠ‚æ‰€ä»‹ç»çš„ï¼Œè¿™ä¸‰é¡¹æ˜¯ä»gmsæœåŠ¡ä¸­å–å‡ºçš„ï¼Œå¹¶ä¸æ˜¯Settings appæœ¬èº«å†…ç½®çš„ï¼Œå› æ­¤å¯ä»¥çœ‹ä½œæ˜¯åŠ¨æ€åŠ è½½ã€‚&lt;/p&gt;

&lt;p&gt;13è¡Œåˆ›å»ºäº†ä¸€ä¸ªSummaryLoaderå¯¹è±¡ï¼Œä»ä¹‹å‰çš„åˆ†æå¯çŸ¥ï¼Œä¼šåˆ›å»ºä¸€ä¸ªHandlerThreadç½®äºåå°è¿è¡Œã€‚&lt;/p&gt;

&lt;p&gt;14è¡ŒæŠŠè‡ªå·±è®¾ç½®ä¸ºSummaryConsumeræ¥å£å¯¹è±¡ï¼Œå½“SummaryLoaderåå°æ›´æ–°å®Œï¼Œä¼šè°ƒç”¨setListeningWï¼Œè¿™ä¸ªæ–¹æ³•åˆä¼šå–å‡ºæ‰€æœ‰æ»¡è¶³è¦æ±‚çš„SummaryProviderå»æ‰§è¡ŒsetListeningæ–¹æ³•ï¼ŒSummaryProvideråˆä¼šåè¿‡æ¥è°ƒç”¨SummaryLoaderçš„setSummaryæ–¹æ³•ï¼ŒSummaryLoaderè¿™æ—¶ä¼špostä¸€ä¸ªupdateSummaryIfNeededæ–¹æ³•åˆ°ä¸»çº¿ç¨‹æ‰§è¡Œï¼Œè€Œè¿™ä¸ªæ–¹æ³•ä¼šå–å‡ºmSummaryConsumerä¹Ÿå°±æ˜¯DashboardFragmentå»æ‰§è¡ŒnotifySummaryChangedæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•ä¼šè·å–tileå…³è”çš„preferenceï¼Œæ‰§è¡Œå…¶setSummaryæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•åˆä¼šè°ƒç”¨notifyChangedæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•è°ƒç”¨OnPreferenceChangeInternalListeneræ¥å£çš„onPreferenceChangeæ–¹æ³•ï¼Œè€ŒPreferenceGroupAdapterå®ç°äº†è¿™ä¸ªæ¥å£ï¼Œå› æ­¤æœ€ç»ˆé€šè¿‡PreferenceGroupAdapterå®ç°äº†viewä¸­Summaryçš„æ›´æ–°ã€‚&lt;/p&gt;

&lt;p&gt;25-29è¡Œåˆ›å»ºPreferenceå¯¹è±¡ï¼Œå¹¶ä¸”å°†Preferenceå’ŒTileè¿›è¡Œç»‘å®šï¼Œç„¶åæ·»åŠ åˆ°PreferenceScreenä¸­ã€‚&lt;/p&gt;

&lt;p&gt;34è¡Œè°ƒç”¨SummaryLoaderçš„setListeningæ–¹æ³•ï¼Œä»å‰é¢ä¸€èŠ‚åˆ†æå¯çŸ¥ï¼Œè¿™ä¸ªæ“ä½œä¼šå¾€åå°HandlerThreadå‘é€ä¸€ä¸ªæ¶ˆæ¯ï¼Œä»è€Œåœ¨åå°ç›‘å¬Summaryæ˜¯å¦æœ‰æ›´æ–°&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;private SummaryProvider getSummaryProvider(Tile tile) {
    if (!mActivity.getPackageName().equals(tile.intent.getComponent().getPackageName())) {
        // Not within Settings, can&#39;t load Summary directly.
        // TODO: Load summary indirectly.
        return null;
    }
    ...
    return null;
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;åœ¨SummaryLoaderçš„getSummaryProvideræ–¹æ³•ç¬¬äºŒè¡Œä¸­å½“å‰åŒ…åä¸ºcom.android.settingsï¼Œè€Œtileçš„åŒ…åä¸ºcom.google.android.gmsï¼Œå› æ­¤è¿”å›ç©ºï¼Œä»æ³¨é‡Šä¹Ÿå¯ä»¥çœ‹å‡ºï¼Œå¦‚æœå½“å‰çš„tileä¸åœ¨Settingsåº”ç”¨ä¸­ï¼Œæ˜¯ä¸èƒ½è·å–åˆ°SummaryProviderçš„ã€‚å› æ­¤åé¢çš„é€šçŸ¥Adapterè¿›è¡ŒSummaryçš„åˆ·æ–°æ“ä½œä¹Ÿå°±ä¸ä¼šæ‰§è¡Œäº†ï¼Œ&lt;/p&gt;

&lt;h1 id=&#34;3-aosp-8-0-settingssearchåˆ†æ&#34;&gt;3.aosp 8.0 SettingsSearchåˆ†æ&lt;/h1&gt;

&lt;p&gt;ç±»å›¾&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;https://ws4.sinaimg.cn/large/006tNbRwgy1fx3eqhh74zj30u017aqc3.jpg&#34; alt=&#34;aospsearchclass&#34; /&gt;&lt;/p&gt;

&lt;h2 id=&#34;3-1æœç´¢çš„æ•°æ®æº&#34;&gt;3.1æœç´¢çš„æ•°æ®æº&lt;/h2&gt;

&lt;p&gt;SearchIndexableData:ç”¨äºæœç´¢çš„å¯ç´¢å¼•æ•°æ®&lt;/p&gt;

&lt;p&gt;SearchIndexableResourceï¼šxmlèµ„æº&lt;/p&gt;

&lt;p&gt;SearchIndexableRawï¼šåŸå§‹æ•°æ®&lt;/p&gt;

&lt;p&gt;BaseColumnsï¼šåŸºç±»ï¼Œrankæ’åï¼ŒclassNameç±»åï¼ŒiconResIdç­‰ï¼›&lt;/p&gt;

&lt;p&gt;XmlResourceï¼šxmlçš„èµ„æºidï¼Œå…³è”SearchIndexableResource&lt;/p&gt;

&lt;p&gt;RawDataï¼šåŸå§‹æ•°æ®ï¼Œtitleæ ‡é¢˜ï¼Œsummaryæ¦‚è¦ç­‰ï¼›å…³è”SearchIndexableData&lt;/p&gt;

&lt;p&gt;NonIndexableKeyï¼šæè¿°ä¸€ä¸ªä¸èƒ½è¢«ç´¢å¼•çš„æ•°æ®&lt;/p&gt;

&lt;p&gt;SearchIndexablesProviderï¼šç”¨äºæœç´¢çš„å¯ç´¢å¼•providerçš„åŸºç±»ï¼Œç”¨äºç»™æœç´¢æä¾›preferenceçš„xmlæ–‡ä»¶æ•°æ®æˆ–è€…åŸå§‹æ•°æ®ã€‚&lt;/p&gt;

&lt;p&gt;ä»¥ä¸Šçš„ç±»é™¤äº†SearchIndexableRawå¤–å…¶ä»–éƒ½ä½äºframeworkåŒ…ä¸­ï¼›&lt;/p&gt;

&lt;p&gt;ä»¥ä¸‹çš„ç±»æˆ–æ¥å£ä½äºsettingsä¸­ï¼›&lt;/p&gt;

&lt;p&gt;Indexable.SearchIndexProviderï¼šæ¥å£ï¼Œå…¶å®ç°ç±»çš„å®ä¾‹å¯ä»¥æä¾›å¯ç´¢å¼•çš„æ•°æ®&lt;/p&gt;

&lt;p&gt;SettingsSearchIndexablesProviderï¼šè®¾ç½®appä¸­çš„content providerï¼Œå®ç°äº†SearchIndexablesPreviderçš„ç›¸å…³æœç´¢æ–¹æ³•ï¼Œåœ¨phoneçš„appä¸­ä¹Ÿæœ‰ä¸€ä¸ªç±»ä¼¼çš„å®ç°:PhoneSearchIndexablesProviderï¼Œä»è€Œå¯ä»¥åœ¨è®¾ç½®çš„æœç´¢ä¸­æ‰¾åˆ°Phoneä¸­çš„xmlæ•°æ®è¿›è¡Œè·³è½¬&lt;/p&gt;

&lt;p&gt;BaseSearchIndexProviderï¼š&lt;/p&gt;

&lt;p&gt;IndexDatabaseHelperï¼šæä¾›æ•°æ®åº“çš„æ“ä½œï¼Œæ•°æ®åº“æ–‡ä»¶ä½äºdata/user_de/0/com.android.settings/databases/search_index.db&lt;/p&gt;

&lt;h2 id=&#34;3-2æ•°æ®åº“æ„å»ºè¿‡ç¨‹&#34;&gt;3.2æ•°æ®åº“æ„å»ºè¿‡ç¨‹&lt;/h2&gt;

&lt;p&gt;è®¾ç½®ä¸­çš„ç•Œé¢å¤§éƒ¨åˆ†éƒ½æ˜¯é€šè¿‡xmlæ–‡ä»¶ä¸­å£°æ˜çš„Preferenceç±»çš„å„ç§å­ç±»æ„å»ºè€Œæˆï¼Œé¡µé¢æ‰“å¼€æ—¶é€šè¿‡è§£æxmlæ–‡ä»¶ä¸­çš„å„ä¸ªèŠ‚ç‚¹ä»è€Œæ„å»ºæˆlistviewä¸­çš„å„ä¸ªitemä»è€Œè¿›è¡Œæ˜¾ç¤ºï¼Œä»¥æ—¥æœŸå’Œæ—¶é—´é¡µé¢DateTimeSettingsä¸ºä¾‹:&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;https://ws1.sinaimg.cn/large/006tNbRwgy1fx11cudlk5j307g0chjru.jpg&#34; alt=&#34;datatimephone&#34; /&gt;&lt;/p&gt;

&lt;p&gt;æ„æˆè¿™ä¸ªç•Œé¢çš„æ–‡ä»¶date_time_prefs.xmlå¦‚ä¸‹&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;&amp;lt;?xml version=&amp;quot;1.0&amp;quot; encoding=&amp;quot;utf-8&amp;quot;?&amp;gt;

&amp;lt;PreferenceScreen xmlns:android=&amp;quot;http://schemas.android.com/apk/res/android&amp;quot;
        xmlns:settings=&amp;quot;http://schemas.android.com/apk/res/com.android.settings&amp;quot;
        android:title=&amp;quot;@string/date_and_time&amp;quot; 
        settings:keywords=&amp;quot;@string/keywords_date_and_time&amp;quot;&amp;gt;

    &amp;lt;com.android.settingslib.RestrictedSwitchPreference android:key=&amp;quot;auto_time&amp;quot;
        android:title=&amp;quot;@string/date_time_auto&amp;quot;
        android:summaryOn=&amp;quot;@string/date_time_auto_summaryOn&amp;quot;
        android:summaryOff=&amp;quot;@string/date_time_auto_summaryOff&amp;quot;
        settings:useAdditionalSummary=&amp;quot;true&amp;quot;
        settings:restrictedSwitchSummary=&amp;quot;@string/enabled_by_admin&amp;quot;
        /&amp;gt;

    &amp;lt;SwitchPreference android:key=&amp;quot;auto_zone&amp;quot;
        android:title=&amp;quot;@string/zone_auto&amp;quot;
        android:summaryOn=&amp;quot;@string/zone_auto_summaryOn&amp;quot;
        android:summaryOff=&amp;quot;@string/zone_auto_summaryOff&amp;quot;
        /&amp;gt;

    &amp;lt;Preference android:key=&amp;quot;date&amp;quot;
        android:title=&amp;quot;@string/date_time_set_date&amp;quot;
        android:summary=&amp;quot;03/10/2008&amp;quot;
        /&amp;gt;

    &amp;lt;Preference android:key=&amp;quot;time&amp;quot;
        android:title=&amp;quot;@string/date_time_set_time&amp;quot;
        android:summary=&amp;quot;12:00am&amp;quot;
        /&amp;gt;

    &amp;lt;Preference
        android:fragment=&amp;quot;com.android.settings.datetime.ZonePicker&amp;quot;
        android:key=&amp;quot;timezone&amp;quot;
        android:title=&amp;quot;@string/date_time_set_timezone&amp;quot;
        android:summary=&amp;quot;GMT-8:00&amp;quot;
        /&amp;gt;

    &amp;lt;SwitchPreference android:key=&amp;quot;24 hour&amp;quot;
        android:title=&amp;quot;@string/date_time_24hour&amp;quot;
        /&amp;gt;

&amp;lt;/PreferenceScreen&amp;gt;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ä¸Šè¿°çš„xmlæ–‡ä»¶çš„æ¯ä¸€é¡¹è·Ÿç•Œé¢å±•ç¤ºæ˜¯ä¸€ä¸€å¯¹åº”çš„ï¼Œå®é™…æƒ…å†µä¹Ÿå¯èƒ½ä¸ä¸€æ ·ï¼Œå¯ä»¥é€šè¿‡é…ç½®ä¸€äº›å±æ€§æˆ–è€…ä»£ç åŠ¨æ€å¢åˆ ä¸€äº›é¡¹ã€‚&lt;/p&gt;

&lt;p&gt;titleä¸ºæ˜¾ç¤ºçš„æ ‡é¢˜ï¼Œsummaryä¸ºæ‘˜è¦ï¼Œkeywordsä¸ºå…³é”®è¯ï¼ˆä¸ç›´æ¥æ˜¾ç¤ºï¼Œç”¨äºæœç´¢ï¼‰ï¼Œç•™æ„ä¸Šé¢çš„settings:keywords=&amp;ldquo;@string/keywords_date_and_time&amp;rdquo;ä¸­keywords_date_and_timeçš„å€¼ä¸º&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;string name=&amp;quot;keywords_date_and_time&amp;quot; msgid=&amp;quot;758325881602648204&amp;quot;&amp;gt;&amp;quot;æ—¶é’Ÿ, å†›ç”¨&amp;quot;&amp;lt;/string&amp;gt;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ä¸Šé¢å†™çš„æ˜¯ç•Œé¢è·Ÿxmlçš„å…³ç³»ï¼Œæœç´¢è¿‡ç¨‹æ˜¯ä¸€ä¸ªæ•°æ®åº“çš„æ£€ç´¢è¿‡ç¨‹ï¼Œå› æ­¤æœç´¢éœ€è¦ç”¨åˆ°æ•°æ®åº“ï¼Œæ•°æ®åº“æ•°æ®çš„æ¥æºå°±æ˜¯ä¸Šé¢çš„xmlæ–‡ä»¶ï¼Œä»æ¨¡æ‹Ÿå™¨å–å‡ºsearch_index.dbæ•°æ®åº“è§‚å¯Ÿï¼Œå¦‚ä¸‹å›¾&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;https://ws2.sinaimg.cn/large/006tNbRwgy1fx1282l0m3j30t40fpq77.jpg&#34; alt=&#34;searchdb&#34; /&gt;&lt;/p&gt;

&lt;p&gt;å¯è§xmlçš„æ•°æ®è·Ÿæ•°æ®åº“ä¸­çš„è®°å½•ä¹Ÿæ˜¯ä¸€ä¸€å¯¹åº”çš„ï¼Œå› æ­¤æœç´¢è¿‡ç¨‹å°±æ˜¯æ•°æ®åº“çš„æ£€ç´¢è¿‡ç¨‹ï¼Œè¾“å…¥æœç´¢çš„å­—ç¬¦ä¸²æœ€ç»ˆä¼šè½¬æ¢æˆSQLæ•°æ®åº“æŸ¥è¯¢è¯­å¥ä»è€Œè¿”å›æŸ¥è¯¢ç»“æœã€‚&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;https://ws1.sinaimg.cn/large/006tNbRwgy1fx12ff9u4tj307j0d8aal.jpg&#34; alt=&#34;å†›ç”¨&#34; /&gt;&lt;/p&gt;

&lt;p&gt;ä¹‹æ‰€ä»¥æœç´¢å†›ç”¨èƒ½å‡ºç°æ—¥æœŸå’Œæ—¶é—´çš„ç»“æœï¼Œæ˜¯å› ä¸ºâ€œå†›ç”¨â€æ˜¯keywordçš„ä¸€éƒ¨åˆ†&lt;/p&gt;

&lt;p&gt;è®¾ç½®ä¸­ä¹Ÿèƒ½æœç´¢å…¶ä»–appçš„æ•°æ®ï¼Œåªè¦å…¶å®ç°äº†SearchIndexablesProviderï¼Œä»¥phoneçš„appä¸ºä¾‹ï¼Œ&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;public class PhoneSearchIndexablesProvider extends SearchIndexablesProvider {
    private static final String TAG = &amp;quot;PhoneSearchIndexablesProvider&amp;quot;;

    private static SearchIndexableResource[] INDEXABLE_RES = new SearchIndexableResource[] {
            new SearchIndexableResource(1, R.xml.network_setting_fragment,
                    MobileNetworkSettings.class.getName(),
                    R.mipmap.ic_launcher_phone),
    };

    ...

    @Override
    public Cursor queryXmlResources(String[] projection) {
        ....
    }
   ...
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;è¿™æ ·å®ç°åï¼ˆè¿˜éœ€è¦åœ¨AndroidManifesté‡Œé¢åšäº›é…ç½®ï¼‰ï¼Œè®¾ç½®appå°±èƒ½è·¨è¿›ç¨‹å–åˆ°network_setting_fragment.xmlä¸­çš„æ•°æ®å¹¶åŠ å…¥search_index.dbæ•°æ®åº“ï¼Œå¦‚ä¸‹&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;https://ws2.sinaimg.cn/large/006tNbRwgy1fx12zl3typj30u30cc41w.jpg&#34; alt=&#34;phonedb&#34; /&gt;&lt;/p&gt;

&lt;p&gt;ä¸‹é¢ç®€å•åˆ†æä¸‹æ•°æ®åº“çš„åˆ›å»ºè¿‡ç¨‹ï¼š&lt;/p&gt;

&lt;p&gt;åˆšè¿›å…¥è®¾ç½®åˆ›å»ºæ•°æ®åº“æµç¨‹å¦‚ä¸‹ï¼š&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;https://ws1.sinaimg.cn/large/006tNbRwgy1fx2a2t9qhzj31050t9gnq.jpg&#34; alt=&#34;aospsearchcreatedb&#34; /&gt;&lt;/p&gt;

&lt;p&gt;å½“ç‚¹å‡»æœç´¢æŒ‰é’®åä¼šå¯åŠ¨SearchFragment&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;@Override
public void onAttach(Context context) {
    super.onAttach(context);
    mSearchFeatureProvider = FeatureFactory.getFactory(context).getSearchFeatureProvider();
    mMetricsFeatureProvider = FeatureFactory.getFactory(context).getMetricsFeatureProvider();
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;é¦–å…ˆä¼šåˆ›å»ºmSearchFeatureProviderï¼Œ&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;@Override
public void onCreate(Bundle savedInstanceState) {
    super.onCreate(savedInstanceState);
    setHasOptionsMenu(true);

    final LoaderManager loaderManager = getLoaderManager();
    mSearchAdapter = new SearchResultsAdapter(this);
    mSavedQueryController = new SavedQueryController(
            getContext(), loaderManager, mSearchAdapter);
    mSearchFeatureProvider.initFeedbackButton();

    ...
    
    // Run the Index update only if we have some space
    if (!Utils.isLowStorage(activity)) {
        mSearchFeatureProvider.updateIndex(activity, this /* indexingCallback */);
    } else {
        Log.w(TAG, &amp;quot;Cannot update the Indexer as we are running low on storage space!&amp;quot;);
    }
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;åœ¨onCreateä¸­ä¼šæ‰§è¡Œç´¢å¼•è¿‡ç¨‹ï¼Œ&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;@Override
public void updateIndex(Context context, IndexingCallback callback) {
    long indexStartTime = System.currentTimeMillis();
    getIndexingManager(context).indexDatabase(callback);
    ...
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æ¥ç€ä¼šæ‰§è¡ŒIndexManagerçš„indexDatabaseæ–¹æ³•&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;public void indexDatabase(IndexingCallback callback) {
    IndexingTask task = new IndexingTask(callback);
    task.execute();
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å¼€å¯äº†ä¸€ä¸ªå°ä»»åŠ¡ï¼ŒIndexingTaskæ˜¯ä¸€ä¸ªAsyncTaskï¼Œåå°æ‰§è¡ŒperformIndexingæ–¹æ³•&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;@Override
protected Void doInBackground(Void... voids) {
    performIndexing();
    return null;
}
&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code&gt;/**
 * Accumulate all data and non-indexable keys from each of the content-providers.
 * Only the first indexing for the default language gets static search results - subsequent
 * calls will only gather non-indexable keys.
 */
@VisibleForTesting
void performIndexing() {
    final Intent intent = new Intent(SearchIndexablesContract.PROVIDER_INTERFACE);
    // è¿™é‡Œæ˜¯è¿”å›æ‰‹æœºä¸­æ‰€æœ‰å£°æ˜äº†actionä¸º&amp;quot;android.content.action.SEARCH_INDEXABLES_PROVIDER&amp;quot;çš„providerçš„ä¿¡æ¯ï¼Œæš‚æ—¶åªæœ‰ä¸‰ä¸ªåº”ç”¨åšäº†è¿™ä¸ªå£°æ˜ï¼ŒSettingsï¼ŒPhoneå’Œcellbroadcastreceiverï¼Œå› æ­¤Settingsçš„æœç´¢ä¸­å¯ä»¥æœç´¢åˆ°phoneçš„appä¸­çš„ä¿¡æ¯ä»è€Œè¿›è¡Œè·³è½¬ã€‚
    final List&amp;lt;ResolveInfo&amp;gt; list =
            mContext.getPackageManager().queryIntentContentProviders(intent, 0);

    String localeStr = Locale.getDefault().toString();
    String fingerprint = Build.FINGERPRINT;
    final boolean isFullIndex = isFullIndex(localeStr, fingerprint);

    if (isFullIndex) {
        rebuildDatabase();
    }

    for (final ResolveInfo info : list) {
        if (!DatabaseIndexingUtils.isWellKnownProvider(info, mContext)) {
            continue;
        }
        final String authority = info.providerInfo.authority;
        final String packageName = info.providerInfo.packageName;

        if (isFullIndex) {
        	åŠ è½½å¤–éƒ¨appçš„ç´¢å¼•
            addIndexablesFromRemoteProvider(packageName, authority);
        }
        addNonIndexablesKeysFromRemoteProvider(packageName, authority);
    }
	// æ›´æ–°åˆ°æ•°æ®åº“
    updateDatabase(isFullIndex, localeStr);
	...
}
&lt;/code&gt;&lt;/pre&gt;

&lt;h1 id=&#34;3-3æ•°æ®æœç´¢ä»¥åŠæ˜¾ç¤ºè¿‡ç¨‹&#34;&gt;3.3æ•°æ®æœç´¢ä»¥åŠæ˜¾ç¤ºè¿‡ç¨‹&lt;/h1&gt;

&lt;p&gt;åœ¨æœç´¢æ¡†è¾“å…¥å­—ç¬¦åï¼Œä¼šå›è°ƒåˆ°SearchFragmentçš„onQueryTextChangeæ–¹æ³•&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;@Override
public boolean onQueryTextChange(String query) {
    ...
    if (isEmptyQuery) {
        ...
    } else {
        restartLoaders();
    }
  ...
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æ•´ä¸ªæœç´¢è¿‡ç¨‹æ¶‰åŠåˆ°äº†Loaderæœºåˆ¶ï¼Œ&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;@Override
public Loader&amp;lt;List&amp;lt;? extends SearchResult&amp;gt;&amp;gt; onCreateLoader(int id, Bundle args) {
    final Activity activity = getActivity();

    switch (id) {
        case LOADER_ID_DATABASE:
            return mSearchFeatureProvider.getDatabaseSearchLoader(activity, mQuery);
        case LOADER_ID_INSTALLED_APPS:
            return mSearchFeatureProvider.getInstalledAppSearchLoader(activity, mQuery);
        default:
            return null;
    }
}
&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code&gt;@Override
public List&amp;lt;? extends SearchResult&amp;gt; loadInBackground() {
    ...

    primaryFirstWordResults = firstWordQuery(MATCH_COLUMNS_PRIMARY, BASE_RANKS[0]);
    primaryMidWordResults = secondaryWordQuery(MATCH_COLUMNS_PRIMARY, BASE_RANKS[1]);
    secondaryResults = anyWordQuery(MATCH_COLUMNS_SECONDARY, BASE_RANKS[2]);
    tertiaryResults = anyWordQuery(MATCH_COLUMNS_TERTIARY, BASE_RANKS[3]);

    final List&amp;lt;SearchResult&amp;gt; results = new ArrayList&amp;lt;&amp;gt;(
            primaryFirstWordResults.size()
            + primaryMidWordResults.size()
            + secondaryResults.size()
            + tertiaryResults.size());

    results.addAll(primaryFirstWordResults);
    results.addAll(primaryMidWordResults);
    results.addAll(secondaryResults);
    results.addAll(tertiaryResults);

    return removeDuplicates(results);
}
&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code&gt;private List&amp;lt;SearchResult&amp;gt; firstWordQuery(String[] matchColumns, int baseRank) {
    final String whereClause = buildSingleWordWhereClause(matchColumns);
    final String query = mQueryText + &amp;quot;%&amp;quot;;
    final String[] selection = buildSingleWordSelection(query, matchColumns.length);

    return query(whereClause, selection, baseRank);
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;(data_title like ?  OR data_title_normalized like ? ) AND enabled = 1&lt;/p&gt;

&lt;p&gt;æ—¥æœŸ%&lt;/p&gt;

&lt;p&gt;% æ—¥æœŸ%&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;@Override
public void onLoadFinished(Loader&amp;lt;List&amp;lt;? extends SearchResult&amp;gt;&amp;gt; loader,
        List&amp;lt;? extends SearchResult&amp;gt; data) {
    mSearchAdapter.addSearchResults(data, loader.getClass().getName());
    if (mUnfinishedLoadersCount.decrementAndGet() != 0) {
        return;
    }
    final int resultCount = mSearchAdapter.displaySearchResults();

    if (resultCount == 0) {
        mNoResultsView.setVisibility(View.VISIBLE);
    } else {
        mNoResultsView.setVisibility(View.GONE);
        mResultsRecyclerView.scrollToPosition(0);
    }
    mSearchFeatureProvider.showFeedbackButton(this, getView());
}
&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code&gt;/**
 * Merge the results from each of the loaders into one list for the adapter.
 * Prioritizes results from the local database over installed apps.
 *
 * @return Number of matched results
 */
public int displaySearchResults() {
    final List&amp;lt;? extends SearchResult&amp;gt; databaseResults = mResultsMap
            .get(DatabaseResultLoader.class.getName());
    final List&amp;lt;? extends SearchResult&amp;gt; installedAppResults = mResultsMap
            .get(InstalledAppResultLoader.class.getName());
    final int dbSize = (databaseResults != null) ? databaseResults.size() : 0;
    final int appSize = (installedAppResults != null) ? installedAppResults.size() : 0;
    final List&amp;lt;SearchResult&amp;gt; newResults = new ArrayList&amp;lt;&amp;gt;(dbSize + appSize);

    int dbIndex = 0;
    int appIndex = 0;
    int rank = TOP_RANK;

    while (rank &amp;lt;= BOTTOM_RANK) {
        while ((dbIndex &amp;lt; dbSize) &amp;amp;&amp;amp; (databaseResults.get(dbIndex).rank == rank)) {
            newResults.add(databaseResults.get(dbIndex++));
        }
        while ((appIndex &amp;lt; appSize) &amp;amp;&amp;amp; (installedAppResults.get(appIndex).rank == rank)) {
            newResults.add(installedAppResults.get(appIndex++));
        }
        rank++;
    }

    while (dbIndex &amp;lt; dbSize) {
        newResults.add(databaseResults.get(dbIndex++));
    }
    while (appIndex &amp;lt; appSize) {
        newResults.add(installedAppResults.get(appIndex++));
    }

    final DiffUtil.DiffResult diffResult = DiffUtil.calculateDiff(
            new SearchResultDiffCallback(mSearchResults, newResults), false /* detectMoves */);
    mSearchResults = newResults;
    diffResult.dispatchUpdatesTo(this);

    return mSearchResults.size();
}
&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code&gt;public void dispatchUpdatesTo(final RecyclerView.Adapter adapter) {
    dispatchUpdatesTo(new ListUpdateCallback() {
        @Override
        public void onInserted(int position, int count) {
            adapter.notifyItemRangeInserted(position, count);
        }

        @Override
        public void onRemoved(int position, int count) {
            adapter.notifyItemRangeRemoved(position, count);
        }

        @Override
        public void onMoved(int fromPosition, int toPosition) {
            adapter.notifyItemMoved(fromPosition, toPosition);
        }

        @Override
        public void onChanged(int position, int count, Object payload) {
            adapter.notifyItemRangeChanged(position, count, payload);
        }
    });
}
&lt;/code&gt;&lt;/pre&gt;
</description>
      
    </item>
    
    <item>
      <title>æ— éšœç¢å­¦ä¹ æ•´ç†ï¼ˆåŸºäºtalkbackï¼‰</title>
      <link>https://xuanliangdev.github.io/post/%E6%97%A0%E9%9A%9C%E7%A2%8D%E5%AD%A6%E4%B9%A0%E6%95%B4%E7%90%86%E4%B8%BB%E8%A6%81%E7%A0%94%E7%A9%B6talkback%E7%9A%84%E6%97%A0%E9%9A%9C%E7%A2%8D%E6%9C%8D%E5%8A%A1/</link>
      <pubDate>Sat, 03 Aug 2019 00:00:00 +0000</pubDate>
      
      <guid>https://xuanliangdev.github.io/post/%E6%97%A0%E9%9A%9C%E7%A2%8D%E5%AD%A6%E4%B9%A0%E6%95%B4%E7%90%86%E4%B8%BB%E8%A6%81%E7%A0%94%E7%A9%B6talkback%E7%9A%84%E6%97%A0%E9%9A%9C%E7%A2%8D%E6%9C%8D%E5%8A%A1/</guid>
      
        <description>

&lt;h2 id=&#34;ä¸€-ç–‘é—®&#34;&gt;ä¸€ã€ç–‘é—®ï¼š&lt;/h2&gt;

&lt;p&gt;1.æ— éšœç¢æœºåˆ¶æ¶‰åŠå“ªäº›æ¨¡å—ï¼Ÿ&lt;/p&gt;

&lt;p&gt;2.å¼€å¯talkbackåtalkbackæ‰‹åŠ¿ç”Ÿæ•ˆåŸç†ï¼Ÿ&lt;/p&gt;

&lt;p&gt;3.æ— éšœç¢ç„¦ç‚¹çš„æ–¹æ¡†å¦‚ä½•äº§ç”Ÿï¼Ÿ&lt;/p&gt;

&lt;p&gt;4.talkbackå¦‚ä½•è·å–viewçš„å†…å®¹ä»è€Œè°ƒç”¨ttsè¿›è¡Œæœ—è¯»ï¼Ÿ&lt;/p&gt;

&lt;p&gt;5.ä¸ºä»€ä¹ˆå®ç°äº†AccessibilityServiceçš„apkå®‰è£…åè®¾ç½®æ— éšœç¢å°±ä¼šå‡ºç°ç›¸å…³çš„å¼€å…³ï¼Ÿ&lt;/p&gt;

&lt;p&gt;6.æ‰“å¼€æŸä¸ªé¡µé¢æ—¶talkbackçš„é»˜è®¤ç„¦ç‚¹æ€ä¹ˆæ¥çš„ï¼Ÿ&lt;/p&gt;

&lt;h2 id=&#34;äºŒ-ç»“æ„åˆ†æ&#34;&gt;äºŒã€ç»“æ„åˆ†æ&lt;/h2&gt;

&lt;h3 id=&#34;1-ä»£ç ç»“æ„&#34;&gt;1.ä»£ç ç»“æ„&lt;/h3&gt;

&lt;p&gt;&lt;img src=&#34;https://ws3.sinaimg.cn/large/006tNc79gy1g1t8b1vx1zj317l0signa.jpg&#34; alt=&#34;æ— éšœç¢æ¶æ„&#34; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;https://ws1.sinaimg.cn/large/006tNc79gy1g1t8avpt29j30vh0u01kx.jpg&#34; alt=&#34;accessibilityclass&#34; /&gt;&lt;/p&gt;

&lt;p&gt;æ•´ä¸ªtalkbackæœºåˆ¶æ¶‰åŠäº†4ä¸ªè¿›ç¨‹ï¼ŒSystemServerï¼ˆè“è‰²éƒ¨åˆ†ï¼‰ã€Talkbackï¼ˆé»„è‰²éƒ¨åˆ†ï¼‰ã€å‰å°appè¿›ç¨‹ï¼ˆç»¿è‰²éƒ¨åˆ†ï¼‰ï¼ŒTTSå¼•æ“è¿›ç¨‹ï¼ˆæš‚ä¸åˆ†æï¼‰&lt;/p&gt;

&lt;p&gt;å››ä¸ªAIDLæ¥å£ï¼Œå›¾ä¸Šçº¢è‰²éƒ¨åˆ†&lt;/p&gt;

&lt;h4 id=&#34;1-1-talkback-è¾…åŠ©app-å®ç°äº†accessibilityserviceçš„app&#34;&gt;1.1ã€talkbackï¼ˆè¾…åŠ©appï¼Œå®ç°äº†AccessibilityServiceçš„appï¼‰&lt;/h4&gt;

&lt;p&gt;&lt;img src=&#34;https://ws1.sinaimg.cn/large/006tNc79gy1g1qzm48qapj30b40abacc.jpg&#34; alt=&#34;WX20190404-224703@2x&#34; /&gt;&lt;/p&gt;

&lt;p&gt;talkbackå®ç°äº†AccessiblityServiceç”¨äºæ¥æ”¶ç³»ç»Ÿä¼ è¿‡æ¥çš„æ— éšœç¢äº‹ä»¶ã€‚&lt;/p&gt;

&lt;h4 id=&#34;1-2-å‰å°appè¿›ç¨‹-è¢«è¾…åŠ©app&#34;&gt;1.2ã€å‰å°appè¿›ç¨‹ï¼ˆè¢«è¾…åŠ©appï¼‰&lt;/h4&gt;

&lt;p&gt;&lt;img src=&#34;https://ws4.sinaimg.cn/large/006tNc79gy1g1r0sbx0bxj30b40b8421.jpg&#34; alt=&#34;viewaccessibility&#34; /&gt;&lt;/p&gt;

&lt;h4 id=&#34;1-3-system-process&#34;&gt;1.3ã€system_process&lt;/h4&gt;

&lt;p&gt;1.3.1ï¼ˆAccessibilityManagerServiceï¼‰&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;https://ws2.sinaimg.cn/large/006tNc79gy1g1r04mvninj30b40d8q73.jpg&#34; alt=&#34;acms&#34; /&gt;&lt;/p&gt;

&lt;p&gt;ç³»ç»Ÿè¿›ç¨‹SystemServerç»´æŠ¤äº†ActivityManagerServiceï¼Œç”¨æ¥ä½œä¸ºbinderæœåŠ¡ç«¯ï¼ŒSystemServerå¯åŠ¨æ—¶ä¼šå¯åŠ¨AccessibilityManagerServiceã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;com.android.server.SystemServer.java

/**
 * Starts a miscellaneous grab bag of stuff that has yet to be refactored
 * and organized.
 */
private void startOtherServices() {
...
            traceBeginAndSlog(&amp;quot;StartAccessibilityManagerService&amp;quot;);
            try {
                ServiceManager.addService(Context.ACCESSIBILITY_SERVICE,
                        new AccessibilityManagerService(context));
            } catch (Throwable e) {
                reportWtf(&amp;quot;starting Accessibility Manager&amp;quot;, e);
            }
            traceEnd();
...
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;1.3.2ã€TTS&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;https://ws3.sinaimg.cn/large/006tNc79gy1g1rg51wbiij30b40m0q9h.jpg&#34; alt=&#34;tts&#34; /&gt;&lt;/p&gt;

&lt;h4 id=&#34;4-è¯­éŸ³å¼•æ“&#34;&gt;4.è¯­éŸ³å¼•æ“&lt;/h4&gt;

&lt;p&gt;æš‚ä¸åˆ†æ&lt;/p&gt;

&lt;h3 id=&#34;1-2-aidlæ¥å£&#34;&gt;1.2 AIDLæ¥å£&lt;/h3&gt;

&lt;p&gt;è·¨è¿›ç¨‹é€šä¿¡çš„éœ€è¦ç”¨åˆ°aidlï¼Œç†è§£aidlçš„è®¾è®¡æ˜¯ç†è§£æ— éšœç¢æ¡†æ¶çš„å…³é”®ã€‚&lt;/p&gt;

&lt;h4 id=&#34;1-2-1-iaccessibilityserviceclient&#34;&gt;1.2.1 ã€IAccessibilityServiceClient&lt;/h4&gt;

&lt;p&gt;æœåŠ¡ç«¯ä¸ºè¾…åŠ©appè¿›ç¨‹ï¼ˆtalkbackï¼‰ï¼Œè°ƒç”¨å®¢æˆ·ç«¯ä¸ºSystemServerè¿›ç¨‹ã€‚&lt;/p&gt;

&lt;p&gt;å½“SystemServerç»‘å®šAccessibilityServiceæ—¶ï¼ŒAccessibilityServiceä¼šè¿”å›å®ç°è¯¥æ¥å£çš„binderå¯¹è±¡ç»™SystemServerè¿›ç¨‹ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;android.accessibilityservice.IAccessibilityServiceClient.aidl

/**
 * Top-level interface to an accessibility service component.
 */
oneway interface IAccessibilityServiceClient {

    void onAccessibilityEvent(in AccessibilityEvent event, in boolean serviceWantsEvent);

    void onSoftKeyboardShowModeChanged(int showMode);

    void onPerformGestureResult(int sequence, boolean completedSuccessfully);

    void onAccessibilityButtonClicked();

    void onAccessibilityButtonAvailabilityChanged(boolean available);
    
    ...
}
&lt;/code&gt;&lt;/pre&gt;

&lt;h4 id=&#34;1-2-2-iaccessibilityserviceconnection&#34;&gt;1.2.2ã€IAccessibilityServiceConnection&lt;/h4&gt;

&lt;p&gt;æœåŠ¡ç«¯ä¸ºSystemServerè¿›ç¨‹ï¼Œè°ƒç”¨å®¢æˆ·ç«¯ä¸ºè¾…åŠ©appè¿›ç¨‹ï¼ˆtalkbackï¼‰ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;android.accessibilityservice.IAccessibilityServiceConnection.aidl

/**
 * Interface given to an AccessibilitySerivce to talk to the AccessibilityManagerService.
 */
interface IAccessibilityServiceConnection {

    String[] findAccessibilityNodeInfoByAccessibilityId(int accessibilityWindowId,
        long accessibilityNodeId, int interactionId,
        IAccessibilityInteractionConnectionCallback callback, int flags, long threadId,
        in Bundle arguments);

    String[] findAccessibilityNodeInfosByViewId(int accessibilityWindowId,
        long accessibilityNodeId, String viewId, int interactionId,
        IAccessibilityInteractionConnectionCallback callback, long threadId);

    String[] findFocus(int accessibilityWindowId, long accessibilityNodeId, int focusType,
        int interactionId, IAccessibilityInteractionConnectionCallback callback, long threadId);

    boolean performAccessibilityAction(int accessibilityWindowId, long accessibilityNodeId,
        int action, in Bundle arguments, int interactionId,
        IAccessibilityInteractionConnectionCallback callback, long threadId);

    AccessibilityServiceInfo getServiceInfo();

    boolean performGlobalAction(int action);

    boolean isAccessibilityButtonAvailable();
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ç”¨äºtalkbackå’Œsystem_processä¹‹é—´ï¼ŒæœåŠ¡ç«¯ä¸ºsystem_processï¼ˆAccessibilityManagerServiceï¼‰ï¼Œå®¢æˆ·ç«¯ä¸ºtalkbackã€‚&lt;/p&gt;

&lt;h4 id=&#34;1-2-3-iaccessibilitymanager&#34;&gt;1.2.3ã€IAccessibilityManager&lt;/h4&gt;

&lt;p&gt;æœåŠ¡ç«¯ä¸ºSystemServerè¿›ç¨‹ï¼Œè°ƒç”¨å®¢æˆ·ç«¯ä¸ºè¢«è¾…åŠ©appè¿›ç¨‹ã€‚&lt;/p&gt;

&lt;p&gt;å½“è¢«è¾…åŠ©appäº§ç”Ÿè§¦æ‘¸äº‹ä»¶åï¼Œä¼šé€šè¿‡è¿™ä¸ªæ¥å£å‘é€æ— éšœç¢äº‹ä»¶ç»™SystemServerè¿›ç¨‹çš„AccessibilityManagerService&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;android.view.accessibility.IAccessibilityManager.aidl

/**
 * Interface implemented by the AccessibilityManagerService called by
 * the AccessibilityManagers.
 *
 * @hide
 */
interface IAccessibilityManager {

    oneway void sendAccessibilityEvent(in AccessibilityEvent uiEvent, int userId);

    long addClient(IAccessibilityManagerClient client, int userId);

    List&amp;lt;AccessibilityServiceInfo&amp;gt; getInstalledAccessibilityServiceList(int userId);

    List&amp;lt;AccessibilityServiceInfo&amp;gt; getEnabledAccessibilityServiceList(int feedbackType, int userId);

    int addAccessibilityInteractionConnection(IWindow windowToken,
            in IAccessibilityInteractionConnection connection,
            String packageName, int userId);

    void removeAccessibilityInteractionConnection(IWindow windowToken);

    void notifyAccessibilityButtonClicked();

    // Requires WRITE_SECURE_SETTINGS
    void performAccessibilityShortcut();

}
&lt;/code&gt;&lt;/pre&gt;

&lt;h4 id=&#34;1-2-4-iaccessibilityinteractionconnection&#34;&gt;1.2.4ã€IAccessibilityInteractionConnection&lt;/h4&gt;

&lt;p&gt;æœåŠ¡ç«¯ä¸ºè¢«è¾…åŠ©appè¿›ç¨‹ï¼Œè°ƒç”¨å®¢æˆ·ç«¯ä¸ºSystemServerè¿›ç¨‹ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;android.view.accessibility.IAccessibilityInteractionConnection.aidl

/**
 * Interface for interaction between the AccessibilityManagerService
 * and the ViewRoot in a given window.
 *
 * @hide
 */
oneway interface IAccessibilityInteractionConnection {

    void findAccessibilityNodeInfoByAccessibilityId(long accessibilityNodeId, in Region bounds,
        int interactionId, IAccessibilityInteractionConnectionCallback callback, int flags,
        int interrogatingPid, long interrogatingTid, in MagnificationSpec spec,
        in Bundle arguments);

    ...

    void findFocus(long accessibilityNodeId, int focusType, in Region bounds, int interactionId,
        IAccessibilityInteractionConnectionCallback callback, int flags, int interrogatingPid,
        long interrogatingTid, in MagnificationSpec spec);

  ...

    void performAccessibilityAction(long accessibilityNodeId, int action, in Bundle arguments,
        int interactionId, IAccessibilityInteractionConnectionCallback callback, int flags,
        int interrogatingPid, long interrogatingTid);
}
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;ä¸‰-æµç¨‹åˆ†æ&#34;&gt;ä¸‰ã€æµç¨‹åˆ†æ&lt;/h2&gt;

&lt;h3 id=&#34;1-talkbackå¼€å…³æ‰“å¼€ååˆ°talkbackserviceå¯åŠ¨è¿‡ç¨‹&#34;&gt;1ã€talkbackå¼€å…³æ‰“å¼€ååˆ°TalkbackServiceå¯åŠ¨è¿‡ç¨‹ã€‚&lt;/h3&gt;

&lt;p&gt;1.1ã€åœ¨è®¾ç½®ä¸­æ‰“å¼€talbackå¼€å…³åï¼Œä¼šè°ƒç”¨åˆ°å¦‚ä¸‹æ–¹æ³•ï¼Œæœ€ç»ˆä¼šå¾€Settings providerä¸­keyä¸ºSettings.Secure.ENABLED_ACCESSIBILITY_SERVICESçš„å­—æ®µå†™å…¥Talkbackæ³¨å†Œçš„AccessibilityServiceå€¼ï¼ˆTalkbackServiceï¼‰ï¼Œè¿™ä¸ªå€¼ä¿å­˜åœ¨&lt;/p&gt;

&lt;p&gt;/data/system/users/0/settings_secure.xmlæ–‡ä»¶ä¸­ã€‚ï¼ˆå…¶ä»–appçš„AccessibilityServiceä¹Ÿä¿å­˜åœ¨åŒä¸€ä¸ªkeyä¸­ï¼‰&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;com.android.settingslib.accessibility.AccessibilityUtils.java

/**
 * Changes an accessibility component&#39;s state for {@param userId}.
 */
public static void setAccessibilityServiceState(Context context, ComponentName toggledService,
        boolean enabled, int userId) {
    ...
    Settings.Secure.putStringForUser(context.getContentResolver(),
            Settings.Secure.ENABLED_ACCESSIBILITY_SERVICES,
            enabledServicesBuilder.toString(), userId);
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ç”±äºAccessibilityManagerServiceåˆ›å»ºæ—¶æ³¨å†Œäº†AccessibilityContentObserverï¼Œå› æ­¤é©¬ä¸Šä¼šæ”¶åˆ°Settings provideræ•°æ®å˜åŒ–çš„ç›‘å¬ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;com.android.server.accessibility.AccessibilityServiceConnection.java

private void updateServicesLocked(UserState userState) {
    ...
        if (userState.mEnabledServices.contains(componentName)
                &amp;amp;&amp;amp; !mUiAutomationManager.suppressingAccessibilityServicesLocked()) {
            if (service == null) {
                service = new AccessibilityServiceConnection(userState, mContext, componentName,
                        installedService, sIdCounter++, mMainHandler, mLock, mSecurityPolicy,
                        this, mWindowManagerService, mGlobalActionPerformer);
            } 
            ...
            service.bindLocked();
        } ...
    }
    ...
    updateAccessibilityEnabledSetting(userState);
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æ ¹æ®è·å–åˆ°çš„AccessibilityServiceä¿¡æ¯ï¼ˆcom.google.android.marvin.talkback/com.google.android.marvin.talkback.TalkBackServiceï¼‰åˆ›å»ºå‡ºAccessibilityServiceConnectionã€‚AccessibilityServiceConnectionä»£è¡¨äº†ä¸€ä¸ªæ— éšœç¢æœåŠ¡ï¼Œå­˜å‚¨ç”¨äºç®¡ç†è¿™ä¸ªæœåŠ¡éœ€è¦çš„æ‰€æœ‰æ•°æ®ï¼Œæä¾›äº†å¼€å§‹/åœæ­¢æœåŠ¡å’Œåœ¨æœåŠ¡ç®¡ç†çš„æ•°æ®ç»“æ„ä¸­æ·»åŠ æˆ–è€…ç§»é™¤è¿™ä¸ªæœåŠ¡çš„apiã€‚&lt;/p&gt;

&lt;p&gt;æ¥ç€è°ƒç”¨bindServiceAsUseræ–¹æ³•æ¥ç»‘å®šæœåŠ¡ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;com.android.server.accessibility.AccessibilityServiceConnection.java

public void bindLocked() {
    ...
    try {
        ...
        if (mService == null &amp;amp;&amp;amp; mContext.bindServiceAsUser(
                mIntent, this, flags, new UserHandle(userState.mUserId))) {
            userState.getBindingServicesLocked().add(mComponentName);
        }
    } ...
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æœåŠ¡å¯åŠ¨åä¼šè·¨è¿›ç¨‹è°ƒç”¨åˆ°TalkbackService(AccessibilityService)çš„onBindæ–¹æ³•&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;android.accessibilityservice.AccessibilityService

/**
 * Implement to return the implementation of the internal accessibility
 * service interface.
 */
@Override
public final IBinder onBind(Intent intent) {
    return new IAccessibilityServiceClientWrapper(this, getMainLooper(), new Callbacks() {
        @Override
        public void onServiceConnected() {
            AccessibilityService.this.dispatchServiceConnected();
        }

        ...
        @Override
        public void onAccessibilityEvent(AccessibilityEvent event) {
            AccessibilityService.this.onAccessibilityEvent(event);
        }
...
    });
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;onBindæ–¹æ³•è¿”å›çš„æ˜¯ä¸€ä¸ªIAccessibilityServiceClientWrapperçš„binderå¯¹è±¡&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;/**
 * Implements the internal {@link IAccessibilityServiceClient} interface to convert
 * incoming calls to it back to calls on an {@link AccessibilityService}.
 *
 * @hide
 */
public static class IAccessibilityServiceClientWrapper extends IAccessibilityServiceClient.Stub
        implements HandlerCaller.Callback {
    ...

    private final HandlerCaller mCaller;

    private final Callbacks mCallback;

    private int mConnectionId = AccessibilityInteractionClient.NO_ID;

    public IAccessibilityServiceClientWrapper(Context context, Looper looper,
            Callbacks callback) {
        mCallback = callback;
        mCaller = new HandlerCaller(context, looper, this, true /*asyncHandler*/);
    }

    public void init(IAccessibilityServiceConnection connection, int connectionId,
            IBinder windowToken) {
        Message message = mCaller.obtainMessageIOO(DO_INIT, connectionId,
                connection, windowToken);
        mCaller.sendMessage(message);
    }

    ...

    public void onAccessibilityEvent(AccessibilityEvent event, boolean serviceWantsEvent) {
        Message message = mCaller.obtainMessageBO(
                DO_ON_ACCESSIBILITY_EVENT, serviceWantsEvent, event);
        mCaller.sendMessage(message);
    }
...

    @Override
    public void executeMessage(Message message) {
        switch (message.what) {
            case DO_ON_ACCESSIBILITY_EVENT: {
                AccessibilityEvent event = (AccessibilityEvent) message.obj;
                boolean serviceWantsEvent = message.arg1 != 0;
                if (event != null) {
                    // Send the event to AccessibilityCache via AccessibilityInteractionClient
                    AccessibilityInteractionClient.getInstance().onAccessibilityEvent(event);
                    if (serviceWantsEvent
                            &amp;amp;&amp;amp; (mConnectionId != AccessibilityInteractionClient.NO_ID)) {
                        // Send the event to AccessibilityService
                        mCallback.onAccessibilityEvent(event);
                    }
                    ...
                }
            } return;

            ...
            case DO_INIT: {
                mConnectionId = message.arg1;
                SomeArgs args = (SomeArgs) message.obj;
                IAccessibilityServiceConnection connection =
                        (IAccessibilityServiceConnection) args.arg1;
                IBinder windowToken = (IBinder) args.arg2;
                args.recycle();
                if (connection != null) {
                    AccessibilityInteractionClient.getInstance().addConnection(mConnectionId,
                            connection);
                    mCallback.init(mConnectionId, windowToken);
                    mCallback.onServiceConnected();
                }...
            } return;
...
        }
    }
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;IAccessibilityServiceClientWrapperä¸­ä¿å­˜äº†ä¸€ä¸ªHandlerCallerå’ŒCallbackså¯¹è±¡ï¼Œå…¶ä¸­HandlerCallerä¸»è¦æ˜¯å°†SystemServerè¿›ç¨‹ä¸­AccessibilityServiceConnectionçš„binder callçš„binderçº¿ç¨‹è°ƒç ”åˆ‡æ¢åˆ°AccessibilityServiceçš„ä¸»çº¿ç¨‹è°ƒç”¨ã€‚Callbackså¯¹è±¡åˆ™å°†IAccessibilityServiceClientWrapperä¸­çš„è°ƒç”¨å›è°ƒåˆ°AccessibilityServiceä¸­ã€‚&lt;/p&gt;

&lt;p&gt;AccessibilityServiceè¿”å›binderåä¼šèµ°åˆ°AccessibilityServiceConnectionçš„onServiceConnectedè°ƒç”¨ä¸­:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;com.android.server.accessibility.AccessibilityServiceConnection.java

@Override
public void onServiceConnected(ComponentName componentName, IBinder service) {
    synchronized (mLock) {
        ...
        mServiceInterface = IAccessibilityServiceClient.Stub.asInterface(service);
        ...
        userState.addServiceLocked(this);
        mSystemSupport.onClientChange(false);
        // Initialize the service on the main handler after we&#39;re done setting up for
        // the new configuration (for example, initializing the input filter).
        mMainHandler.sendMessage(obtainMessage(
                AccessibilityServiceConnection::initializeService, this));
    }
}
&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code&gt;private void initializeService() {
    IAccessibilityServiceClient serviceInterface = null;
    ...
    try {
        serviceInterface.init(this, mId, mOverlayWindowToken);
    } catch (RemoteException re) {
        ...
    }
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;åœ¨serviceInterface.initæ–¹æ³•ä¸­ï¼ˆbinderè°ƒç”¨ï¼‰å°†è¿™ä¸ªAccessibilityServiceConnectionã€mIdå’ŒmOverlayWindowTokenä¼ ç»™AccessibilityServiceå®Œæˆåˆå§‹åŒ–å·¥ä½œã€‚&lt;/p&gt;

&lt;p&gt;åˆå§‹åŒ–æ—¶ä¼šè°ƒç”¨&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;AccessibilityInteractionClient.getInstance().addConnection(mConnectionId,
        connection);
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å°†AccessibilityServiceConnectionä¿å­˜åˆ°AccessibilityInteractionClientä¸­ã€‚&lt;/p&gt;

&lt;h3 id=&#34;2-è§¦æ‘¸äº‹ä»¶å‡ºå‘åˆ°ç„¦ç‚¹ç»˜åˆ¶è¿‡ç¨‹&#34;&gt;2ã€è§¦æ‘¸äº‹ä»¶å‡ºå‘åˆ°ç„¦ç‚¹ç»˜åˆ¶è¿‡ç¨‹ã€‚&lt;/h3&gt;

&lt;p&gt;2.1 è§¦æ‘¸äº‹ä»¶å‘å‡ºåˆ°AccessibilityServiceæ¥æ”¶åˆ°onAccessibilityEventäº‹ä»¶æµç¨‹&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;https://ws2.sinaimg.cn/large/006tNc79gy1g1t16x2ozmj313g0u0x0h.jpg&#34; alt=&#34;accessibilitytouch&#34; /&gt;&lt;/p&gt;

&lt;p&gt;2.2 talkbackå‘å‡ºfocusäº‹ä»¶é€šçŸ¥ViewRootImplç»˜åˆ¶ç»¿æ¡†ç„¦ç‚¹è¿‡ç¨‹ã€‚&lt;/p&gt;

&lt;h3 id=&#34;3-talkbackè°ƒç”¨ttså‘å‡ºå£°éŸ³è¿‡ç¨‹&#34;&gt;3ã€talkbackè°ƒç”¨TTSå‘å‡ºå£°éŸ³è¿‡ç¨‹ã€‚&lt;/h3&gt;

&lt;h1 id=&#34;å››-è§£ç–‘&#34;&gt;å››ã€è§£ç–‘&lt;/h1&gt;

&lt;p&gt;1.æ— éšœç¢æœºåˆ¶æ¶‰åŠå“ªäº›æ¨¡å—ï¼Ÿç­”æ¡ˆå¦‚ä¸Šåˆ†æ&lt;/p&gt;

&lt;p&gt;2.å¼€å¯talkbackåtalkbackæ‰‹åŠ¿ç”Ÿæ•ˆåŸç†ï¼Ÿ&lt;/p&gt;

&lt;p&gt;ç­”ï¼šserviceçš„xmlé…ç½®ä¸­android:canRequestTouchExplorationMode=&amp;ldquo;true&amp;rdquo;&lt;/p&gt;

&lt;p&gt;é…ä¸Šè¿™ä¸ªå±æ€§æ—¶com.android.server.accessibility.TouchExplorerä¼šç”Ÿæ•ˆï¼Œè¯¥ç±»ä¼šå¤„ç†æ— éšœç¢æ‰‹åŠ¿ã€‚&lt;/p&gt;

&lt;p&gt;3.æ— éšœç¢ç„¦ç‚¹çš„æ–¹æ¡†å¦‚ä½•äº§ç”Ÿï¼Ÿ&lt;/p&gt;

&lt;p&gt;ç­”ï¼šViewRootImpè¿›è¡Œç»˜åˆ¶&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;android.view.ViewRootImpl.java

/**
 * We want to draw a highlight around the current accessibility focused.
 * Since adding a style for all possible view is not a viable option we
 * have this specialized drawing method.
 *
 * Note: We are doing this here to be able to draw the highlight for
 *       virtual views in addition to real ones.
 *
 * @param canvas The canvas on which to draw.
 */
private void drawAccessibilityFocusedDrawableIfNeeded(Canvas canvas) {
    final Rect bounds = mAttachInfo.mTmpInvalRect;
    if (getAccessibilityFocusedRect(bounds)) {
        final Drawable drawable = getAccessibilityFocusedDrawable();
        if (drawable != null) {
            drawable.setBounds(bounds);
            drawable.draw(canvas);
        }
    } else if (mAttachInfo.mAccessibilityFocusDrawable != null) {
        mAttachInfo.mAccessibilityFocusDrawable.setBounds(0, 0, 0, 0);
    }
}

private boolean getAccessibilityFocusedRect(Rect bounds) {
    final AccessibilityManager manager = AccessibilityManager.getInstance(mView.mContext);
    if (!manager.isEnabled() || !manager.isTouchExplorationEnabled()) {
        return false;
    }

    final View host = mAccessibilityFocusedHost;
    if (host == null || host.mAttachInfo == null) {
        return false;
    }

    final AccessibilityNodeProvider provider = host.getAccessibilityNodeProvider();
    if (provider == null) {
        host.getBoundsOnScreen(bounds, true);
    } else if (mAccessibilityFocusedVirtualView != null) {
        mAccessibilityFocusedVirtualView.getBoundsInScreen(bounds);
    } else {
        return false;
    }

    // Transform the rect into window-relative coordinates.
    final AttachInfo attachInfo = mAttachInfo;
    bounds.offset(0, attachInfo.mViewRootImpl.mScrollY);
    bounds.offset(-attachInfo.mWindowLeft, -attachInfo.mWindowTop);
    if (!bounds.intersect(0, 0, attachInfo.mViewRootImpl.mWidth,
            attachInfo.mViewRootImpl.mHeight)) {
        // If no intersection, set bounds to empty.
        bounds.setEmpty();
    }
    return !bounds.isEmpty();
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å¯ä»¥çœ‹å‡ºï¼Œç»¿æ¡†å‡ºç°çš„æ¡ä»¶æœ‰AccessibilityManagerå¯ç”¨ï¼ˆisEnabledï¼‰ã€å¼€å¯äº†TouchExplorationæ¨¡å¼ï¼ˆåŒä¸Šç¬¬äºŒç‚¹ï¼‰ç­‰ã€‚&lt;/p&gt;

&lt;p&gt;4.talkbackå¦‚ä½•è·å–viewçš„å†…å®¹ä»è€Œè°ƒç”¨ttsè¿›è¡Œæœ—è¯»ï¼Ÿ&lt;/p&gt;

&lt;p&gt;5.ä¸ºä»€ä¹ˆå®ç°äº†AccessibilityServiceçš„apkå®‰è£…åè®¾ç½®æ— éšœç¢å°±ä¼šå‡ºç°ç›¸å…³çš„å¼€å…³ï¼Ÿ&lt;/p&gt;

&lt;p&gt;æœ‰å¾…ç ”ç©¶ï¼ŒçŒœæµ‹æ˜¯ä»PKMSä¸­æŸ¥è¯¢ã€‚&lt;/p&gt;

&lt;p&gt;6.æ‰“å¼€æŸä¸ªé¡µé¢æ—¶talkbackçš„é»˜è®¤ç„¦ç‚¹æ€ä¹ˆæ¥çš„ï¼Ÿ&lt;/p&gt;
</description>
      
    </item>
    
  </channel>
</rss>
