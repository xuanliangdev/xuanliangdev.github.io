<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>xuanliang</title>
    <link>https://xuanliangdev.github.io/</link>
    <description>Recent content on xuanliang</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>en</language>
    <lastBuildDate>Sat, 03 Aug 2019 00:00:00 +0000</lastBuildDate>
    
        <atom:link href="https://xuanliangdev.github.io/index.xml" rel="self" type="application/rss+xml" />
    
    
    <item>
      <title>About</title>
      <link>https://xuanliangdev.github.io/about/</link>
      <pubDate>Sat, 03 Aug 2019 00:00:00 +0000</pubDate>
      
      <guid>https://xuanliangdev.github.io/about/</guid>
      
        <description>

&lt;h2 id=&#34;å¦‚æœä½ æœ‰ç†æƒ³åœ¨è¿œæ–¹-å°±ä¸è¦è¢«è·¯è¾¹çš„é£æ™¯å½±å“äº†å‰è¿›çš„é€Ÿåº¦-å› ä¸ºäººçš„æ—¶é—´æ˜¯æœ‰é™çš„&#34;&gt;â€”â€”å¦‚æœä½ æœ‰ç†æƒ³åœ¨è¿œæ–¹ï¼Œå°±ä¸è¦è¢«è·¯è¾¹çš„é£æ™¯å½±å“äº†å‰è¿›çš„é€Ÿåº¦ï¼Œå› ä¸ºäººçš„æ—¶é—´æ˜¯æœ‰é™çš„ã€‚&lt;/h2&gt;

&lt;p&gt;æ¥å°ç±³å·®ä¸€ä¸ªæœˆå°±æ»¡ä¸€å¹´äº†ï¼Œä¸æ¥ä¹‹å‰çš„é›„å¿ƒå£®å¿—ç›¸æ¯”ï¼Œè¿›æ­¥ä¹‹ç¼“æ…¢è¶…å‡ºäº†é¢„æœŸï¼Œä¸»è¦è¿˜æ˜¯æ²¡æœ‰å®šä¸‹åˆ‡å®çš„ç›®æ ‡å¹¶åšæŒæ‰§è¡Œï¼Œæ²¡æœ‰åœ¨ç¹å¿™çš„æ‚æ´»ä¸­æˆ–è€…æŠ½å‡ºç©ºé—²æ—¶é—´æ€»ç»“æå‡ï¼Œç”šè‡³ä»ä»Šå¹´4æœˆä¸­æ—¬å¼€å§‹èƒ¡æ€ä¹±æƒ³åˆ°äº†ç°åœ¨ï¼Œè¿·å¤±äº†è‡ªå·±ï¼Œæµªè´¹äº†3ä¸ªåŠæœˆï¼Œä»Šå¤©å¼€å§‹é‡æ–°åˆ¶å®šåŠå¹´è®¡åˆ’å¹¶æ‰§è¡Œï¼Œå°½ä¸€åˆ‡åŠªåŠ›æ’é™¤æ‚å¿µğŸ’ªã€‚&lt;/p&gt;

&lt;p&gt;äººæ²¡æœ‰ç›®æ ‡å°±ä¼šèƒ¡æ€ä¹±æƒ³ï¼Œæœ‰äº†ç›®æ ‡å°±è¦åˆ‡å®æ‰§è¡Œï¼Œä¸ç„¶å°±ä¼šåœæ»ä¸å‰ç”šè‡³å€’é€€ã€‚&lt;/p&gt;

&lt;p&gt;ä»Šå¤©æ˜¯2019å¹´8æœˆ3æ—¥ï¼Œä½“æ£€å‘ç°ç”²çŠ¶è…ºç»“èŠ‚ï¼Œè¿˜å¥½æ˜¯è‰¯æ€§çš„ã€‚ã€‚ã€‚&lt;/p&gt;
</description>
      
    </item>
    
    <item>
      <title>æ— éšœç¢å­¦ä¹ æ•´ç†ï¼ˆåŸºäºtalkbackï¼‰</title>
      <link>https://xuanliangdev.github.io/post/%E6%97%A0%E9%9A%9C%E7%A2%8D%E5%AD%A6%E4%B9%A0%E6%95%B4%E7%90%86%E4%B8%BB%E8%A6%81%E7%A0%94%E7%A9%B6talkback%E7%9A%84%E6%97%A0%E9%9A%9C%E7%A2%8D%E6%9C%8D%E5%8A%A1/</link>
      <pubDate>Sat, 03 Aug 2019 00:00:00 +0000</pubDate>
      
      <guid>https://xuanliangdev.github.io/post/%E6%97%A0%E9%9A%9C%E7%A2%8D%E5%AD%A6%E4%B9%A0%E6%95%B4%E7%90%86%E4%B8%BB%E8%A6%81%E7%A0%94%E7%A9%B6talkback%E7%9A%84%E6%97%A0%E9%9A%9C%E7%A2%8D%E6%9C%8D%E5%8A%A1/</guid>
      
        <description>

&lt;h2 id=&#34;ä¸€-ç–‘é—®&#34;&gt;ä¸€ã€ç–‘é—®ï¼š&lt;/h2&gt;

&lt;p&gt;1.æ— éšœç¢æœºåˆ¶æ¶‰åŠå“ªäº›æ¨¡å—ï¼Ÿ&lt;/p&gt;

&lt;p&gt;2.å¼€å¯talkbackåtalkbackæ‰‹åŠ¿ç”Ÿæ•ˆåŸç†ï¼Ÿ&lt;/p&gt;

&lt;p&gt;3.æ— éšœç¢ç„¦ç‚¹çš„æ–¹æ¡†å¦‚ä½•äº§ç”Ÿï¼Ÿ&lt;/p&gt;

&lt;p&gt;4.talkbackå¦‚ä½•è·å–viewçš„å†…å®¹ä»è€Œè°ƒç”¨ttsè¿›è¡Œæœ—è¯»ï¼Ÿ&lt;/p&gt;

&lt;p&gt;5.ä¸ºä»€ä¹ˆå®ç°äº†AccessibilityServiceçš„apkå®‰è£…åè®¾ç½®æ— éšœç¢å°±ä¼šå‡ºç°ç›¸å…³çš„å¼€å…³ï¼Ÿ&lt;/p&gt;

&lt;p&gt;6.æ‰“å¼€æŸä¸ªé¡µé¢æ—¶talkbackçš„é»˜è®¤ç„¦ç‚¹æ€ä¹ˆæ¥çš„ï¼Ÿ&lt;/p&gt;

&lt;h2 id=&#34;äºŒ-ç»“æ„åˆ†æ&#34;&gt;äºŒã€ç»“æ„åˆ†æ&lt;/h2&gt;

&lt;h3 id=&#34;1-ä»£ç ç»“æ„&#34;&gt;1.ä»£ç ç»“æ„&lt;/h3&gt;

&lt;p&gt;&lt;img src=&#34;https://ws3.sinaimg.cn/large/006tNc79gy1g1t8b1vx1zj317l0signa.jpg&#34; alt=&#34;æ— éšœç¢æ¶æ„&#34; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;https://ws1.sinaimg.cn/large/006tNc79gy1g1t8avpt29j30vh0u01kx.jpg&#34; alt=&#34;accessibilityclass&#34; /&gt;&lt;/p&gt;

&lt;p&gt;æ•´ä¸ªtalkbackæœºåˆ¶æ¶‰åŠäº†4ä¸ªè¿›ç¨‹ï¼ŒSystemServerï¼ˆè“è‰²éƒ¨åˆ†ï¼‰ã€Talkbackï¼ˆé»„è‰²éƒ¨åˆ†ï¼‰ã€å‰å°appè¿›ç¨‹ï¼ˆç»¿è‰²éƒ¨åˆ†ï¼‰ï¼ŒTTSå¼•æ“è¿›ç¨‹ï¼ˆæš‚ä¸åˆ†æï¼‰&lt;/p&gt;

&lt;p&gt;å››ä¸ªAIDLæ¥å£ï¼Œå›¾ä¸Šçº¢è‰²éƒ¨åˆ†&lt;/p&gt;

&lt;h4 id=&#34;1-1-talkback-è¾…åŠ©app-å®ç°äº†accessibilityserviceçš„app&#34;&gt;1.1ã€talkbackï¼ˆè¾…åŠ©appï¼Œå®ç°äº†AccessibilityServiceçš„appï¼‰&lt;/h4&gt;

&lt;p&gt;&lt;img src=&#34;https://ws1.sinaimg.cn/large/006tNc79gy1g1qzm48qapj30b40abacc.jpg&#34; alt=&#34;WX20190404-224703@2x&#34; /&gt;&lt;/p&gt;

&lt;p&gt;talkbackå®ç°äº†AccessiblityServiceç”¨äºæ¥æ”¶ç³»ç»Ÿä¼ è¿‡æ¥çš„æ— éšœç¢äº‹ä»¶ã€‚&lt;/p&gt;

&lt;h4 id=&#34;1-2-å‰å°appè¿›ç¨‹-è¢«è¾…åŠ©app&#34;&gt;1.2ã€å‰å°appè¿›ç¨‹ï¼ˆè¢«è¾…åŠ©appï¼‰&lt;/h4&gt;

&lt;p&gt;&lt;img src=&#34;https://ws4.sinaimg.cn/large/006tNc79gy1g1r0sbx0bxj30b40b8421.jpg&#34; alt=&#34;viewaccessibility&#34; /&gt;&lt;/p&gt;

&lt;h4 id=&#34;1-3-system-process&#34;&gt;1.3ã€system_process&lt;/h4&gt;

&lt;p&gt;1.3.1ï¼ˆAccessibilityManagerServiceï¼‰&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;https://ws2.sinaimg.cn/large/006tNc79gy1g1r04mvninj30b40d8q73.jpg&#34; alt=&#34;acms&#34; /&gt;&lt;/p&gt;

&lt;p&gt;ç³»ç»Ÿè¿›ç¨‹SystemServerç»´æŠ¤äº†ActivityManagerServiceï¼Œç”¨æ¥ä½œä¸ºbinderæœåŠ¡ç«¯ï¼ŒSystemServerå¯åŠ¨æ—¶ä¼šå¯åŠ¨AccessibilityManagerServiceã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;com.android.server.SystemServer.java

/**
 * Starts a miscellaneous grab bag of stuff that has yet to be refactored
 * and organized.
 */
private void startOtherServices() {
...
            traceBeginAndSlog(&amp;quot;StartAccessibilityManagerService&amp;quot;);
            try {
                ServiceManager.addService(Context.ACCESSIBILITY_SERVICE,
                        new AccessibilityManagerService(context));
            } catch (Throwable e) {
                reportWtf(&amp;quot;starting Accessibility Manager&amp;quot;, e);
            }
            traceEnd();
...
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;1.3.2ã€TTS&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;https://ws3.sinaimg.cn/large/006tNc79gy1g1rg51wbiij30b40m0q9h.jpg&#34; alt=&#34;tts&#34; /&gt;&lt;/p&gt;

&lt;h4 id=&#34;4-è¯­éŸ³å¼•æ“&#34;&gt;4.è¯­éŸ³å¼•æ“&lt;/h4&gt;

&lt;p&gt;æš‚ä¸åˆ†æ&lt;/p&gt;

&lt;h3 id=&#34;1-2-aidlæ¥å£&#34;&gt;1.2 AIDLæ¥å£&lt;/h3&gt;

&lt;p&gt;è·¨è¿›ç¨‹é€šä¿¡çš„éœ€è¦ç”¨åˆ°aidlï¼Œç†è§£aidlçš„è®¾è®¡æ˜¯ç†è§£æ— éšœç¢æ¡†æ¶çš„å…³é”®ã€‚&lt;/p&gt;

&lt;h4 id=&#34;1-2-1-iaccessibilityserviceclient&#34;&gt;1.2.1 ã€IAccessibilityServiceClient&lt;/h4&gt;

&lt;p&gt;æœåŠ¡ç«¯ä¸ºè¾…åŠ©appè¿›ç¨‹ï¼ˆtalkbackï¼‰ï¼Œè°ƒç”¨å®¢æˆ·ç«¯ä¸ºSystemServerè¿›ç¨‹ã€‚&lt;/p&gt;

&lt;p&gt;å½“SystemServerç»‘å®šAccessibilityServiceæ—¶ï¼ŒAccessibilityServiceä¼šè¿”å›å®ç°è¯¥æ¥å£çš„binderå¯¹è±¡ç»™SystemServerè¿›ç¨‹ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;android.accessibilityservice.IAccessibilityServiceClient.aidl

/**
 * Top-level interface to an accessibility service component.
 */
oneway interface IAccessibilityServiceClient {

    void onAccessibilityEvent(in AccessibilityEvent event, in boolean serviceWantsEvent);

    void onSoftKeyboardShowModeChanged(int showMode);

    void onPerformGestureResult(int sequence, boolean completedSuccessfully);

    void onAccessibilityButtonClicked();

    void onAccessibilityButtonAvailabilityChanged(boolean available);
    
    ...
}
&lt;/code&gt;&lt;/pre&gt;

&lt;h4 id=&#34;1-2-2-iaccessibilityserviceconnection&#34;&gt;1.2.2ã€IAccessibilityServiceConnection&lt;/h4&gt;

&lt;p&gt;æœåŠ¡ç«¯ä¸ºSystemServerè¿›ç¨‹ï¼Œè°ƒç”¨å®¢æˆ·ç«¯ä¸ºè¾…åŠ©appè¿›ç¨‹ï¼ˆtalkbackï¼‰ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;android.accessibilityservice.IAccessibilityServiceConnection.aidl

/**
 * Interface given to an AccessibilitySerivce to talk to the AccessibilityManagerService.
 */
interface IAccessibilityServiceConnection {

    String[] findAccessibilityNodeInfoByAccessibilityId(int accessibilityWindowId,
        long accessibilityNodeId, int interactionId,
        IAccessibilityInteractionConnectionCallback callback, int flags, long threadId,
        in Bundle arguments);

    String[] findAccessibilityNodeInfosByViewId(int accessibilityWindowId,
        long accessibilityNodeId, String viewId, int interactionId,
        IAccessibilityInteractionConnectionCallback callback, long threadId);

    String[] findFocus(int accessibilityWindowId, long accessibilityNodeId, int focusType,
        int interactionId, IAccessibilityInteractionConnectionCallback callback, long threadId);

    boolean performAccessibilityAction(int accessibilityWindowId, long accessibilityNodeId,
        int action, in Bundle arguments, int interactionId,
        IAccessibilityInteractionConnectionCallback callback, long threadId);

    AccessibilityServiceInfo getServiceInfo();

    boolean performGlobalAction(int action);

    boolean isAccessibilityButtonAvailable();
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ç”¨äºtalkbackå’Œsystem_processä¹‹é—´ï¼ŒæœåŠ¡ç«¯ä¸ºsystem_processï¼ˆAccessibilityManagerServiceï¼‰ï¼Œå®¢æˆ·ç«¯ä¸ºtalkbackã€‚&lt;/p&gt;

&lt;h4 id=&#34;1-2-3-iaccessibilitymanager&#34;&gt;1.2.3ã€IAccessibilityManager&lt;/h4&gt;

&lt;p&gt;æœåŠ¡ç«¯ä¸ºSystemServerè¿›ç¨‹ï¼Œè°ƒç”¨å®¢æˆ·ç«¯ä¸ºè¢«è¾…åŠ©appè¿›ç¨‹ã€‚&lt;/p&gt;

&lt;p&gt;å½“è¢«è¾…åŠ©appäº§ç”Ÿè§¦æ‘¸äº‹ä»¶åï¼Œä¼šé€šè¿‡è¿™ä¸ªæ¥å£å‘é€æ— éšœç¢äº‹ä»¶ç»™SystemServerè¿›ç¨‹çš„AccessibilityManagerService&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;android.view.accessibility.IAccessibilityManager.aidl

/**
 * Interface implemented by the AccessibilityManagerService called by
 * the AccessibilityManagers.
 *
 * @hide
 */
interface IAccessibilityManager {

    oneway void sendAccessibilityEvent(in AccessibilityEvent uiEvent, int userId);

    long addClient(IAccessibilityManagerClient client, int userId);

    List&amp;lt;AccessibilityServiceInfo&amp;gt; getInstalledAccessibilityServiceList(int userId);

    List&amp;lt;AccessibilityServiceInfo&amp;gt; getEnabledAccessibilityServiceList(int feedbackType, int userId);

    int addAccessibilityInteractionConnection(IWindow windowToken,
            in IAccessibilityInteractionConnection connection,
            String packageName, int userId);

    void removeAccessibilityInteractionConnection(IWindow windowToken);

    void notifyAccessibilityButtonClicked();

    // Requires WRITE_SECURE_SETTINGS
    void performAccessibilityShortcut();

}
&lt;/code&gt;&lt;/pre&gt;

&lt;h4 id=&#34;1-2-4-iaccessibilityinteractionconnection&#34;&gt;1.2.4ã€IAccessibilityInteractionConnection&lt;/h4&gt;

&lt;p&gt;æœåŠ¡ç«¯ä¸ºè¢«è¾…åŠ©appè¿›ç¨‹ï¼Œè°ƒç”¨å®¢æˆ·ç«¯ä¸ºSystemServerè¿›ç¨‹ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;android.view.accessibility.IAccessibilityInteractionConnection.aidl

/**
 * Interface for interaction between the AccessibilityManagerService
 * and the ViewRoot in a given window.
 *
 * @hide
 */
oneway interface IAccessibilityInteractionConnection {

    void findAccessibilityNodeInfoByAccessibilityId(long accessibilityNodeId, in Region bounds,
        int interactionId, IAccessibilityInteractionConnectionCallback callback, int flags,
        int interrogatingPid, long interrogatingTid, in MagnificationSpec spec,
        in Bundle arguments);

    ...

    void findFocus(long accessibilityNodeId, int focusType, in Region bounds, int interactionId,
        IAccessibilityInteractionConnectionCallback callback, int flags, int interrogatingPid,
        long interrogatingTid, in MagnificationSpec spec);

  ...

    void performAccessibilityAction(long accessibilityNodeId, int action, in Bundle arguments,
        int interactionId, IAccessibilityInteractionConnectionCallback callback, int flags,
        int interrogatingPid, long interrogatingTid);
}
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;ä¸‰-æµç¨‹åˆ†æ&#34;&gt;ä¸‰ã€æµç¨‹åˆ†æ&lt;/h2&gt;

&lt;h3 id=&#34;1-talkbackå¼€å…³æ‰“å¼€ååˆ°talkbackserviceå¯åŠ¨è¿‡ç¨‹&#34;&gt;1ã€talkbackå¼€å…³æ‰“å¼€ååˆ°TalkbackServiceå¯åŠ¨è¿‡ç¨‹ã€‚&lt;/h3&gt;

&lt;p&gt;1.1ã€åœ¨è®¾ç½®ä¸­æ‰“å¼€talbackå¼€å…³åï¼Œä¼šè°ƒç”¨åˆ°å¦‚ä¸‹æ–¹æ³•ï¼Œæœ€ç»ˆä¼šå¾€Settings providerä¸­keyä¸ºSettings.Secure.ENABLED_ACCESSIBILITY_SERVICESçš„å­—æ®µå†™å…¥Talkbackæ³¨å†Œçš„AccessibilityServiceå€¼ï¼ˆTalkbackServiceï¼‰ï¼Œè¿™ä¸ªå€¼ä¿å­˜åœ¨&lt;/p&gt;

&lt;p&gt;/data/system/users/0/settings_secure.xmlæ–‡ä»¶ä¸­ã€‚ï¼ˆå…¶ä»–appçš„AccessibilityServiceä¹Ÿä¿å­˜åœ¨åŒä¸€ä¸ªkeyä¸­ï¼‰&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;com.android.settingslib.accessibility.AccessibilityUtils.java

/**
 * Changes an accessibility component&#39;s state for {@param userId}.
 */
public static void setAccessibilityServiceState(Context context, ComponentName toggledService,
        boolean enabled, int userId) {
    ...
    Settings.Secure.putStringForUser(context.getContentResolver(),
            Settings.Secure.ENABLED_ACCESSIBILITY_SERVICES,
            enabledServicesBuilder.toString(), userId);
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ç”±äºAccessibilityManagerServiceåˆ›å»ºæ—¶æ³¨å†Œäº†AccessibilityContentObserverï¼Œå› æ­¤é©¬ä¸Šä¼šæ”¶åˆ°Settings provideræ•°æ®å˜åŒ–çš„ç›‘å¬ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;com.android.server.accessibility.AccessibilityServiceConnection.java

private void updateServicesLocked(UserState userState) {
    ...
        if (userState.mEnabledServices.contains(componentName)
                &amp;amp;&amp;amp; !mUiAutomationManager.suppressingAccessibilityServicesLocked()) {
            if (service == null) {
                service = new AccessibilityServiceConnection(userState, mContext, componentName,
                        installedService, sIdCounter++, mMainHandler, mLock, mSecurityPolicy,
                        this, mWindowManagerService, mGlobalActionPerformer);
            } 
            ...
            service.bindLocked();
        } ...
    }
    ...
    updateAccessibilityEnabledSetting(userState);
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æ ¹æ®è·å–åˆ°çš„AccessibilityServiceä¿¡æ¯ï¼ˆcom.google.android.marvin.talkback/com.google.android.marvin.talkback.TalkBackServiceï¼‰åˆ›å»ºå‡ºAccessibilityServiceConnectionã€‚AccessibilityServiceConnectionä»£è¡¨äº†ä¸€ä¸ªæ— éšœç¢æœåŠ¡ï¼Œå­˜å‚¨ç”¨äºç®¡ç†è¿™ä¸ªæœåŠ¡éœ€è¦çš„æ‰€æœ‰æ•°æ®ï¼Œæä¾›äº†å¼€å§‹/åœæ­¢æœåŠ¡å’Œåœ¨æœåŠ¡ç®¡ç†çš„æ•°æ®ç»“æ„ä¸­æ·»åŠ æˆ–è€…ç§»é™¤è¿™ä¸ªæœåŠ¡çš„apiã€‚&lt;/p&gt;

&lt;p&gt;æ¥ç€è°ƒç”¨bindServiceAsUseræ–¹æ³•æ¥ç»‘å®šæœåŠ¡ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;com.android.server.accessibility.AccessibilityServiceConnection.java

public void bindLocked() {
    ...
    try {
        ...
        if (mService == null &amp;amp;&amp;amp; mContext.bindServiceAsUser(
                mIntent, this, flags, new UserHandle(userState.mUserId))) {
            userState.getBindingServicesLocked().add(mComponentName);
        }
    } ...
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æœåŠ¡å¯åŠ¨åä¼šè·¨è¿›ç¨‹è°ƒç”¨åˆ°TalkbackService(AccessibilityService)çš„onBindæ–¹æ³•&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;android.accessibilityservice.AccessibilityService

/**
 * Implement to return the implementation of the internal accessibility
 * service interface.
 */
@Override
public final IBinder onBind(Intent intent) {
    return new IAccessibilityServiceClientWrapper(this, getMainLooper(), new Callbacks() {
        @Override
        public void onServiceConnected() {
            AccessibilityService.this.dispatchServiceConnected();
        }

        ...
        @Override
        public void onAccessibilityEvent(AccessibilityEvent event) {
            AccessibilityService.this.onAccessibilityEvent(event);
        }
...
    });
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;onBindæ–¹æ³•è¿”å›çš„æ˜¯ä¸€ä¸ªIAccessibilityServiceClientWrapperçš„binderå¯¹è±¡&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;/**
 * Implements the internal {@link IAccessibilityServiceClient} interface to convert
 * incoming calls to it back to calls on an {@link AccessibilityService}.
 *
 * @hide
 */
public static class IAccessibilityServiceClientWrapper extends IAccessibilityServiceClient.Stub
        implements HandlerCaller.Callback {
    ...

    private final HandlerCaller mCaller;

    private final Callbacks mCallback;

    private int mConnectionId = AccessibilityInteractionClient.NO_ID;

    public IAccessibilityServiceClientWrapper(Context context, Looper looper,
            Callbacks callback) {
        mCallback = callback;
        mCaller = new HandlerCaller(context, looper, this, true /*asyncHandler*/);
    }

    public void init(IAccessibilityServiceConnection connection, int connectionId,
            IBinder windowToken) {
        Message message = mCaller.obtainMessageIOO(DO_INIT, connectionId,
                connection, windowToken);
        mCaller.sendMessage(message);
    }

    ...

    public void onAccessibilityEvent(AccessibilityEvent event, boolean serviceWantsEvent) {
        Message message = mCaller.obtainMessageBO(
                DO_ON_ACCESSIBILITY_EVENT, serviceWantsEvent, event);
        mCaller.sendMessage(message);
    }
...

    @Override
    public void executeMessage(Message message) {
        switch (message.what) {
            case DO_ON_ACCESSIBILITY_EVENT: {
                AccessibilityEvent event = (AccessibilityEvent) message.obj;
                boolean serviceWantsEvent = message.arg1 != 0;
                if (event != null) {
                    // Send the event to AccessibilityCache via AccessibilityInteractionClient
                    AccessibilityInteractionClient.getInstance().onAccessibilityEvent(event);
                    if (serviceWantsEvent
                            &amp;amp;&amp;amp; (mConnectionId != AccessibilityInteractionClient.NO_ID)) {
                        // Send the event to AccessibilityService
                        mCallback.onAccessibilityEvent(event);
                    }
                    ...
                }
            } return;

            ...
            case DO_INIT: {
                mConnectionId = message.arg1;
                SomeArgs args = (SomeArgs) message.obj;
                IAccessibilityServiceConnection connection =
                        (IAccessibilityServiceConnection) args.arg1;
                IBinder windowToken = (IBinder) args.arg2;
                args.recycle();
                if (connection != null) {
                    AccessibilityInteractionClient.getInstance().addConnection(mConnectionId,
                            connection);
                    mCallback.init(mConnectionId, windowToken);
                    mCallback.onServiceConnected();
                }...
            } return;
...
        }
    }
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;IAccessibilityServiceClientWrapperä¸­ä¿å­˜äº†ä¸€ä¸ªHandlerCallerå’ŒCallbackså¯¹è±¡ï¼Œå…¶ä¸­HandlerCallerä¸»è¦æ˜¯å°†SystemServerè¿›ç¨‹ä¸­AccessibilityServiceConnectionçš„binder callçš„binderçº¿ç¨‹è°ƒç ”åˆ‡æ¢åˆ°AccessibilityServiceçš„ä¸»çº¿ç¨‹è°ƒç”¨ã€‚Callbackså¯¹è±¡åˆ™å°†IAccessibilityServiceClientWrapperä¸­çš„è°ƒç”¨å›è°ƒåˆ°AccessibilityServiceä¸­ã€‚&lt;/p&gt;

&lt;p&gt;AccessibilityServiceè¿”å›binderåä¼šèµ°åˆ°AccessibilityServiceConnectionçš„onServiceConnectedè°ƒç”¨ä¸­:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;com.android.server.accessibility.AccessibilityServiceConnection.java

@Override
public void onServiceConnected(ComponentName componentName, IBinder service) {
    synchronized (mLock) {
        ...
        mServiceInterface = IAccessibilityServiceClient.Stub.asInterface(service);
        ...
        userState.addServiceLocked(this);
        mSystemSupport.onClientChange(false);
        // Initialize the service on the main handler after we&#39;re done setting up for
        // the new configuration (for example, initializing the input filter).
        mMainHandler.sendMessage(obtainMessage(
                AccessibilityServiceConnection::initializeService, this));
    }
}
&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code&gt;private void initializeService() {
    IAccessibilityServiceClient serviceInterface = null;
    ...
    try {
        serviceInterface.init(this, mId, mOverlayWindowToken);
    } catch (RemoteException re) {
        ...
    }
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;åœ¨serviceInterface.initæ–¹æ³•ä¸­ï¼ˆbinderè°ƒç”¨ï¼‰å°†è¿™ä¸ªAccessibilityServiceConnectionã€mIdå’ŒmOverlayWindowTokenä¼ ç»™AccessibilityServiceå®Œæˆåˆå§‹åŒ–å·¥ä½œã€‚&lt;/p&gt;

&lt;p&gt;åˆå§‹åŒ–æ—¶ä¼šè°ƒç”¨&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;AccessibilityInteractionClient.getInstance().addConnection(mConnectionId,
        connection);
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å°†AccessibilityServiceConnectionä¿å­˜åˆ°AccessibilityInteractionClientä¸­ã€‚&lt;/p&gt;

&lt;h3 id=&#34;2-è§¦æ‘¸äº‹ä»¶å‡ºå‘åˆ°ç„¦ç‚¹ç»˜åˆ¶è¿‡ç¨‹&#34;&gt;2ã€è§¦æ‘¸äº‹ä»¶å‡ºå‘åˆ°ç„¦ç‚¹ç»˜åˆ¶è¿‡ç¨‹ã€‚&lt;/h3&gt;

&lt;p&gt;2.1 è§¦æ‘¸äº‹ä»¶å‘å‡ºåˆ°AccessibilityServiceæ¥æ”¶åˆ°onAccessibilityEventäº‹ä»¶æµç¨‹&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;https://ws2.sinaimg.cn/large/006tNc79gy1g1t16x2ozmj313g0u0x0h.jpg&#34; alt=&#34;accessibilitytouch&#34; /&gt;&lt;/p&gt;

&lt;p&gt;2.2 talkbackå‘å‡ºfocusäº‹ä»¶é€šçŸ¥ViewRootImplç»˜åˆ¶ç»¿æ¡†ç„¦ç‚¹è¿‡ç¨‹ã€‚&lt;/p&gt;

&lt;h3 id=&#34;3-talkbackè°ƒç”¨ttså‘å‡ºå£°éŸ³è¿‡ç¨‹&#34;&gt;3ã€talkbackè°ƒç”¨TTSå‘å‡ºå£°éŸ³è¿‡ç¨‹ã€‚&lt;/h3&gt;

&lt;h1 id=&#34;å››-è§£ç–‘&#34;&gt;å››ã€è§£ç–‘&lt;/h1&gt;

&lt;p&gt;1.æ— éšœç¢æœºåˆ¶æ¶‰åŠå“ªäº›æ¨¡å—ï¼Ÿç­”æ¡ˆå¦‚ä¸Šåˆ†æ&lt;/p&gt;

&lt;p&gt;2.å¼€å¯talkbackåtalkbackæ‰‹åŠ¿ç”Ÿæ•ˆåŸç†ï¼Ÿ&lt;/p&gt;

&lt;p&gt;ç­”ï¼šserviceçš„xmlé…ç½®ä¸­android:canRequestTouchExplorationMode=&amp;ldquo;true&amp;rdquo;&lt;/p&gt;

&lt;p&gt;é…ä¸Šè¿™ä¸ªå±æ€§æ—¶com.android.server.accessibility.TouchExplorerä¼šç”Ÿæ•ˆï¼Œè¯¥ç±»ä¼šå¤„ç†æ— éšœç¢æ‰‹åŠ¿ã€‚&lt;/p&gt;

&lt;p&gt;3.æ— éšœç¢ç„¦ç‚¹çš„æ–¹æ¡†å¦‚ä½•äº§ç”Ÿï¼Ÿ&lt;/p&gt;

&lt;p&gt;ç­”ï¼šViewRootImpè¿›è¡Œç»˜åˆ¶&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;android.view.ViewRootImpl.java

/**
 * We want to draw a highlight around the current accessibility focused.
 * Since adding a style for all possible view is not a viable option we
 * have this specialized drawing method.
 *
 * Note: We are doing this here to be able to draw the highlight for
 *       virtual views in addition to real ones.
 *
 * @param canvas The canvas on which to draw.
 */
private void drawAccessibilityFocusedDrawableIfNeeded(Canvas canvas) {
    final Rect bounds = mAttachInfo.mTmpInvalRect;
    if (getAccessibilityFocusedRect(bounds)) {
        final Drawable drawable = getAccessibilityFocusedDrawable();
        if (drawable != null) {
            drawable.setBounds(bounds);
            drawable.draw(canvas);
        }
    } else if (mAttachInfo.mAccessibilityFocusDrawable != null) {
        mAttachInfo.mAccessibilityFocusDrawable.setBounds(0, 0, 0, 0);
    }
}

private boolean getAccessibilityFocusedRect(Rect bounds) {
    final AccessibilityManager manager = AccessibilityManager.getInstance(mView.mContext);
    if (!manager.isEnabled() || !manager.isTouchExplorationEnabled()) {
        return false;
    }

    final View host = mAccessibilityFocusedHost;
    if (host == null || host.mAttachInfo == null) {
        return false;
    }

    final AccessibilityNodeProvider provider = host.getAccessibilityNodeProvider();
    if (provider == null) {
        host.getBoundsOnScreen(bounds, true);
    } else if (mAccessibilityFocusedVirtualView != null) {
        mAccessibilityFocusedVirtualView.getBoundsInScreen(bounds);
    } else {
        return false;
    }

    // Transform the rect into window-relative coordinates.
    final AttachInfo attachInfo = mAttachInfo;
    bounds.offset(0, attachInfo.mViewRootImpl.mScrollY);
    bounds.offset(-attachInfo.mWindowLeft, -attachInfo.mWindowTop);
    if (!bounds.intersect(0, 0, attachInfo.mViewRootImpl.mWidth,
            attachInfo.mViewRootImpl.mHeight)) {
        // If no intersection, set bounds to empty.
        bounds.setEmpty();
    }
    return !bounds.isEmpty();
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å¯ä»¥çœ‹å‡ºï¼Œç»¿æ¡†å‡ºç°çš„æ¡ä»¶æœ‰AccessibilityManagerå¯ç”¨ï¼ˆisEnabledï¼‰ã€å¼€å¯äº†TouchExplorationæ¨¡å¼ï¼ˆåŒä¸Šç¬¬äºŒç‚¹ï¼‰ç­‰ã€‚&lt;/p&gt;

&lt;p&gt;4.talkbackå¦‚ä½•è·å–viewçš„å†…å®¹ä»è€Œè°ƒç”¨ttsè¿›è¡Œæœ—è¯»ï¼Ÿ&lt;/p&gt;

&lt;p&gt;5.ä¸ºä»€ä¹ˆå®ç°äº†AccessibilityServiceçš„apkå®‰è£…åè®¾ç½®æ— éšœç¢å°±ä¼šå‡ºç°ç›¸å…³çš„å¼€å…³ï¼Ÿ&lt;/p&gt;

&lt;p&gt;æœ‰å¾…ç ”ç©¶ï¼ŒçŒœæµ‹æ˜¯ä»PKMSä¸­æŸ¥è¯¢ã€‚&lt;/p&gt;

&lt;p&gt;6.æ‰“å¼€æŸä¸ªé¡µé¢æ—¶talkbackçš„é»˜è®¤ç„¦ç‚¹æ€ä¹ˆæ¥çš„ï¼Ÿ&lt;/p&gt;
</description>
      
    </item>
    
  </channel>
</rss>
